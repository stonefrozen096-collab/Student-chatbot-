<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard â€” Feathers</title>

<link rel="stylesheet" href="admin.css">
<link rel="stylesheet" href="chatbot.css">

<!-- Chart.js + Socket.io -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
  /* ---------- Variables ---------- */
  :root{
    --blue:#004aad;
    --blue-strong:#006bff;
    --bg:#f4f6f9;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#667085;
    --purple: #9b59ff; /* purple neon base */
  }

  html,body{height:100%;margin:0;font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;}
  body {
    display:flex;
    height:100vh;
    overflow:hidden;
    background:var(--bg);
    color:var(--text);
    transition: background .6s ease, color .4s ease;
  }

  /* ---------- Sidebar ---------- */
  .sidebar {
    width:220px;
    background:var(--blue);
    color:#fff;
    display:flex;
    flex-direction:column;
    padding-top:20px;
    overflow-y:auto;
  }
  .sidebar button{
    background:transparent;
    border:none;
    color:#fff;
    padding:12px 20px;
    text-align:left;
    font-size:14px;
    cursor:pointer;
    transition:background .15s;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .sidebar button:hover, .sidebar button.active { background: var(--blue-strong); }

  .mainContent{
    flex:1;
    overflow-y:auto;
    padding:20px;
    background:var(--bg);
  }

  .topbar {
    position: sticky;
    top: 0;
    display:flex;
    justify-content: space-between;
    align-items:center;
    gap:12px;
    padding: 8px 0;
    z-index: 50;
    background: transparent;
  }
  .topbar .controls { display:flex; gap:8px; align-items:center; }

  /* ---------- Admin sections/cards ---------- */
  .admin-section{
    display:none;
    background:var(--card);
    border-radius:14px;
    padding:20px;
    margin-bottom:20px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    animation: fadeIn .45s ease;
    transition: box-shadow .45s ease, border .45s ease, background .45s ease;
  }
  h2{ margin-top:0; margin-bottom:12px; }

  @keyframes fadeIn {
    from {opacity:0; transform: translateY(8px);} to {opacity:1; transform: translateY(0);}
  }

  /* ---------- Dark mode (purple neon glow) ---------- */
  body.dark-mode {
    background: #05020a; /* near black */
    color: #e7e7ff;
  }

  body.dark-mode .sidebar {
    background: #020617;
    box-shadow: 0 0 40px rgba(155,89,255,0.22), inset 0 0 14px rgba(155,89,255,0.05);
  }

  body.dark-mode .admin-section {
    background: rgba(8,6,20,0.6);
    color: #f2eefe;
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    border: 1px solid rgba(155,89,255,0.08);
    backdrop-filter: blur(6px);
  }

  /* purple neon glow for headings & important elements (constant) */
  body.dark-mode h2 {
    color: #e9e0ff;
    text-shadow: 0 10px 28px rgba(155,89,255,0.22), 0 2px 6px rgba(155,89,255,0.12);
  }
  body.dark-mode .card-title {
    text-shadow: 0 6px 18px rgba(155,89,255,0.18);
  }

  /* semi-transparent glow boxes */
  .glow-box {
    border-radius: 12px;
    padding: 12px;
    transition: box-shadow .6s ease, transform .35s ease;
  }
  body.dark-mode .glow-box {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
    box-shadow: 0 12px 40px rgba(155,89,255,0.12), inset 0 0 40px rgba(155,89,255,0.04);
    border: 1px solid rgba(155,89,255,0.06);
  }

  /* stronger hover (interactive) */
  .glow-box:hover {
    transform: translateY(-4px);
  }
  body.dark-mode .glow-hover-strong:hover {
    box-shadow: 0 18px 60px rgba(155,89,255,0.28), inset 0 0 40px rgba(155,89,255,0.06);
  }

  /* top-right theme toggle & logout */
  .btn-inline { width:100%; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-size:14px; }
  .theme-btn { background: transparent; border: 1px solid rgba(0,0,0,0.06); padding:8px 12px; border-radius:10px; cursor:pointer; }
  .theme-btn .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:8px; vertical-align:middle; }

  /* toast */
  .toast {
    position: fixed; right: 18px; bottom: 18px; background:#111; color:#fff; padding:10px 14px; border-radius:8px; z-index:99999; box-shadow:0 8px 24px rgba(0,0,0,0.6);
  }
  .toast.info { background:#333; }
  .toast.success { background:#1b8a56; }
  .toast.error { background:#b02a37; }

  /* responsive adjustments */
  @media (max-width:900px){
    .sidebar { width:68px; }
    .sidebar button { font-size:12px; padding:10px; justify-content:center; }
    .topbar .title { display:none; }
    .topbar { padding: 6px 0 12px; }
  }

  /* small table styles */
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom: 1px solid rgba(0,0,0,0.06); text-align:left; }
  body.dark-mode th, body.dark-mode td { border-bottom: 1px solid rgba(255,255,255,0.03); }

  /* button styles */
  .primary { background: linear-gradient(90deg,var(--blue-strong),var(--blue)); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }
  .danger { background:#ff3b3b; color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }

  /* purple neon outlines for interactive controls in dark */
  body.dark-mode .primary { box-shadow: 0 6px 30px rgba(155,89,255,0.12); border: 1px solid rgba(155,89,255,0.04); }
  body.dark-mode .danger { box-shadow: 0 6px 30px rgba(255,60,60,0.06); }
</style>
</head>
<body>

<!-- ============================
     AUTH: cookie/localStorage token check (frontend guard)
     Reads cookie "authToken" or localStorage token; redirects to login if missing.
     ============================ -->
<script>
  // cookie/helpers
  function getCookie(name) {
    const re = new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g,'\\$1') + '=([^;]*)');
    const m = document.cookie.match(re);
    return m ? decodeURIComponent(m[1]) : null;
  }
  function deleteCookie(name){ document.cookie = `${name}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`; }

  (function checkAuth(){
    const token = getCookie('authToken') || localStorage.getItem('token');
    if (!token) {
      // not logged in -> redirect to login
      console.warn('No auth token found.');
      window.location.href = '/login.html';
      return;
    }
    // optional: one-off verify with backend but not blocking UI (non-blocking)
    const API = "https://feathers-26g1.onrender.com";
    fetch(`${API}/api/health`).catch(()=>{ /* ignore */ });
    window.__API_URL = API;
  })();
</script>

<!-- ============================
     Sidebar + Topbar (theme + logout visible)
     ============================ -->
<div class="sidebar" aria-hidden="false">
  <button class="menuBtn active" data-section="attendanceSection">ğŸ“‹ Attendance</button>
  <button class="menuBtn" data-section="testSection">ğŸ“š Test Management</button>
  <button class="menuBtn" data-section="userManagementSection">ğŸ‘¤ Users</button>
  <button class="menuBtn" data-section="badgeSection">ğŸ… Badges</button>
  <button class="menuBtn" data-section="chatbotAdminSection">ğŸ¤– Chatbot</button>
  <button class="menuBtn" data-section="analyticsSection">ğŸ“ˆ Analytics</button>
  <button class="menuBtn" data-section="importExportSection">ğŸ”„ Import/Export</button>
  <button class="menuBtn" data-section="masterCommandSection">âš¡ Master Command</button>
  <button class="menuBtn" data-section="noticeSection">ğŸ“¢ Notices</button>
  <button class="menuBtn" data-section="profileSection">ğŸ‘¤ Profile</button>

  <!-- bottom controls: theme + logout -->
  <div style="margin-top:auto; padding:20px; border-top:1px solid rgba(255,255,255,0.08); display:flex; flex-direction:column; gap:10px;">
    <button id="themeToggleSidebar" class="btn-inline" style="background:#0b2b4a;color:#fff;">ğŸŒ™ Dark Mode</button>
    <button id="logoutBtnSidebar" class="btn-inline" style="background:#ff3b3b;color:#fff;">ğŸšª Logout</button>
  </div>
</div>

<div class="mainContent">
  <div class="topbar">
    <div class="title" style="display:flex;align-items:center;gap:12px;">
      <h1 style="font-size:18px;margin:0">Admin Dashboard</h1>
      <small style="color:var(--muted)">Feathers</small>
    </div>

    <div class="controls">
      <!-- Top-right theme toggle (also visible) -->
      <button id="themeToggleTop" class="theme-btn" title="Toggle theme">
        <span class="dot" id="themeDot" style="background:var(--purple)"></span>
        <span id="themeLabel">Dark Mode</span>
      </button>

      <!-- Top-right logout -->
      <button id="logoutBtnTop" class="theme-btn" style="margin-left:8px;">Logout</button>
    </div>
  </div>

  <!-- Attendance Section -->
  <div id="attendanceSection" class="admin-section">
    <h2 class="card-title">ğŸ“‹ Attendance Management</h2>
    <div class="glow-box" style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
      <label>Select Date:</label>
      <input type="date" id="attendanceDate" />
      <button id="markAllPresentBtn" class="primary">Mark All Present</button>
      <button id="markAllAbsentBtn" class="primary">Mark All Absent</button>
      <button id="refreshAttendanceBtn" class="primary">Refresh</button>
    </div>

    <div class="glow-box">
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>Student</th>
            <th>Present</th>
            <th>Absent</th>
            <th>Late</th>
            <th>On Duty</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:12px;">
      <button id="saveAttendanceBtn" class="primary">ğŸ’¾ Save Attendance</button>
    </div>
  </div>

  <!-- Test Management (shortened placeholder) -->
  <div id="testSection" class="admin-section">
    <h2 class="card-title">ğŸ“ Test Management</h2>
    <div class="glow-box">
      <!-- replicate your existing form here or keep imported module handling -->
      <p>Test management UI (create/test list) â€” modules will enhance this.</p>
    </div>
  </div>

  <!-- User Management -->
  <div id="userManagementSection" class="admin-section">
    <h2 class="card-title">ğŸ‘¤ User Management</h2>
    <div class="glow-box">
      <p>User management table and controls.</p>
    </div>
  </div>

  <!-- Badge -->
  <div id="badgeSection" class="admin-section">
    <h2 class="card-title">ğŸ… Badge Management</h2>
    <div class="glow-box">
      <p>Badge creation & assignment UI.</p>
    </div>
  </div>

  <!-- Chatbot -->
  <div id="chatbotAdminSection" class="admin-section">
    <h2 class="card-title">ğŸ¤– Chatbot Trigger Management</h2>
    <div class="glow-box">
      <p>Trigger list & add UI.</p>
    </div>
  </div>

  <!-- Analytics -->
  <div id="analyticsSection" class="admin-section">
    <h2 class="card-title">ğŸ“ˆ Analytics</h2>
    <div class="glow-box" style="display:flex;gap:12px;flex-wrap:wrap;">
      <div class="glow-box" style="padding:12px;border-radius:10px;min-width:140px;">
        <h4>Total Messages</h4><p id="totalMessages" class="counter" data-count="0">0</p>
      </div>
      <div class="glow-box" style="padding:12px;border-radius:10px;min-width:140px;">
        <h4>Active Users</h4><p id="activeUsers" class="counter" data-count="0">0</p>
      </div>
      <div style="flex-basis:100%;margin-top:12px;">
        <canvas id="messagesChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Import/Export -->
  <div id="importExportSection" class="admin-section">
    <h2 class="card-title">ğŸ”„ Import & Export</h2>
    <div class="glow-box">
      <p>Export/Import controls.</p>
    </div>
  </div>

  <!-- Master Command -->
  <div id="masterCommandSection" class="admin-section">
    <h2 class="card-title">âš¡ Master Command</h2>
    <div class="glow-box">
      <p>Master command list / create / execute.</p>
    </div>
  </div>

  <!-- Notices -->
  <div id="noticeSection" class="admin-section">
    <h2 class="card-title">ğŸ“¢ Notices</h2>
    <div class="glow-box">
      <p>Notice publisher & list.</p>
    </div>
  </div>

  <!-- Profile -->
  <div id="profileSection" class="admin-section">
    <h2 class="card-title">ğŸ‘¤ Profile</h2>
    <div class="glow-box">
      <p>Profile editor & badges.</p>
    </div>
  </div>

</div> <!-- end mainContent -->

<!-- ============================
     Scripts: socket, theme, menu switching, logout, attendance realtime
     ============================ -->
<script>
  const API_URL = window.__API_URL || "https://feathers-26g1.onrender.com";
  // Socket init (exposed for other modules too)
  let socket;
  try {
    socket = io(API_URL, { transports:['websocket','polling'], reconnectionAttempts: 5 });
    window.__SOCKET = socket;
    socket.on('connect', ()=> console.log('Socket connected', socket.id));
    socket.on('disconnect', ()=> console.warn('Socket disconnected'));
  } catch(e){ console.warn('Socket init failed', e); }

  // ---------- Menu switching ----------
  const menuBtns = document.querySelectorAll('.menuBtn');
  const sections = document.querySelectorAll('.admin-section');
  menuBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      menuBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.section;
      sections.forEach(sec=>{
        sec.style.display = (sec.id === target) ? 'block' : 'none';
      });
      document.querySelector('.mainContent').scrollTop = 0;
    });
  });
  // show first by default
  sections.forEach((s,i)=> s.style.display = i===0 ? 'block' : 'none');

  // ---------- THEME toggle (top + sidebar) ----------
  const themeToggleTop = document.getElementById('themeToggleTop');
  const themeToggleSidebar = document.getElementById('themeToggleSidebar');
  const themeLabel = document.getElementById('themeLabel');
  const themeDot = document.getElementById('themeDot');

  function getThemeCookie(){
    return (document.cookie.match(/(?:^|; )theme=([^;]+)/) || [])[1] || localStorage.getItem('theme') || 'light';
  }
  function setThemeCookie(val){
    document.cookie = `theme=${val}; path=/; max-age=${60*60*24*365}; SameSite=Lax`;
    localStorage.setItem('theme', val);
  }

  function applyTheme(isDark){
    document.body.classList.toggle('dark-mode', !!isDark);
    if (isDark) {
      themeLabel.textContent = 'Light Mode';
      themeDot.style.background = 'var(--purple)';
      themeToggleSidebar.textContent = 'â˜€ï¸ Light Mode';
    } else {
      themeLabel.textContent = 'Dark Mode';
      themeDot.style.background = '#666';
      themeToggleSidebar.textContent = 'ğŸŒ™ Dark Mode';
    }
  }
  // init theme
  (function initTheme(){
    const current = getThemeCookie();
    const isDark = current === 'dark';
    applyTheme(isDark);
  })();

  // click handlers (both toggles)
  [themeToggleTop, themeToggleSidebar].forEach(btn=>{
    btn?.addEventListener('click', ()=>{
      const isNowDark = document.body.classList.toggle('dark-mode');
      setThemeCookie(isNowDark ? 'dark' : 'light');
      // smooth fade effect for glow - add small delay for nicer feel
      document.documentElement.style.transition = 'background 0.6s ease, color 0.6s ease';
      applyTheme(isNowDark);
    });
  });

  // ---------- Logout: top + sidebar (confirmation + fade overlay + redirect to /login.html) ----------
  function doLogout() {
    // confirmation dialog
    if (!confirm('Are you sure you want to logout?')) return;
    // overlay fade
    const overlay = document.createElement('div');
    overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='#000'; overlay.style.opacity=0;
    overlay.style.transition='opacity .6s ease'; overlay.style.zIndex=99999;
    document.body.appendChild(overlay);
    requestAnimationFrame(()=> overlay.style.opacity = 0.6);
    // clear tokens (cookies/localStorage)
    setTimeout(()=>{
      document.cookie = 'authToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      window.location.href = '/login.html';
    }, 600);
  }
  document.getElementById('logoutBtnTop').addEventListener('click', doLogout);
  document.getElementById('logoutBtnSidebar').addEventListener('click', doLogout);

  // ---------- Toast helper ----------
  function showToast(message, type='info') {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = message;
    document.body.appendChild(t);
    setTimeout(()=> t.remove(), 3000);
  }

  // ---------- Attendance: local rendering + socket real-time ----------
  const attendanceTableBody = document.querySelector('#attendanceTable tbody');
  function renderAttendanceList(list){
    attendanceTableBody.innerHTML = '';
    list.forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.username || row.email || 'â€”'}</td>
        <td><input type="radio" name="att_${row.username}" value="present" ${row.status==='present'?'checked':''}></td>
        <td><input type="radio" name="att_${row.username}" value="absent" ${row.status==='absent'?'checked':''}></td>
        <td><input type="radio" name="att_${row.username}" value="late" ${row.status==='late'?'checked':''}></td>
        <td><input type="radio" name="att_${row.username}" value="onduty" ${row.status==='onduty'?'checked':''}></td>
        <td class="statusCell">${row.status || 'â€”'}</td>
      `;
      attendanceTableBody.appendChild(tr);
    });
  }

  // initial load function (calls backend)
  async function loadAttendance() {
    try {
      const token = document.cookie.match(/(?:^|; )authToken=([^;]+)/)?.[1] || localStorage.getItem('token');
      const res = await fetch(`${API_URL}/api/attendance`, {
        headers: token ? { Authorization: `Bearer ${token}` } : {}
      });
      if (!res.ok) {
        console.warn('Failed to fetch attendance', await res.text());
        return;
      }
      const data = await res.json();
      // map to simple list
      const list = (Array.isArray(data) ? data : data.all || []).map(x => ({ username: x.username || x.id || x.email, status: x.status || null, date: x.date }));
      renderAttendanceList(list);
    } catch (err) {
      console.error('loadAttendance error', err);
    }
  }
  // load on start
  loadAttendance();

  // listen socket updates
  if (socket) {
    socket.on('attendanceUpdated', (payload) => {
      // payload: { date, records }
      if (!payload) return;
      showToast('Attendance updated (real-time)', 'info');
      const recs = payload.records?.map(r => ({ username: r.username, status: r.status })) || [];
      // merge with current table: for simplicity re-render with updated records
      renderAttendanceList(recs);
    });
  }

  // Save attendance (collect UI radio inputs)
  document.getElementById('saveAttendanceBtn').addEventListener('click', async ()=>{
    const rows = Array.from(attendanceTableBody.querySelectorAll('tr'));
    const entries = rows.map(r => {
      const username = r.children[0].textContent.trim();
      const radios = r.querySelectorAll('input[type="radio"]');
      let status = null;
      radios.forEach(rd => { if (rd.checked) status = rd.value; });
      return { username, date: document.getElementById('attendanceDate').value || new Date().toISOString().slice(0,10), status };
    });
    // send to API (also emit socket)
    try {
      const token = document.cookie.match(/(?:^|; )authToken=([^;]+)/)?.[1] || localStorage.getItem('token');
      await fetch(`${API_URL}/api/attendance`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...(token?{Authorization:`Bearer ${token}`}:{} ) },
        body: JSON.stringify({ entries })
      });
      // emit via socket (optional)
      socket?.emit('attendance:save', { date: entries[0]?.date, records: entries});
      showToast('Attendance saved', 'success');
    } catch (err) {
      console.error('saveAttendance failed', err);
      showToast('Failed to save attendance', 'error');
    }
  });

  // helpers for mark all present/absent
  document.getElementById('markAllPresentBtn').addEventListener('click', ()=> {
    attendanceTableBody.querySelectorAll('tr').forEach(tr => {
      const r = tr.querySelector('input[value="present"]'); if (r) r.checked = true;
      tr.querySelector('.statusCell').textContent = 'present';
    });
  });
  document.getElementById('markAllAbsentBtn').addEventListener('click', ()=> {
    attendanceTableBody.querySelectorAll('tr').forEach(tr => {
      const r = tr.querySelector('input[value="absent"]'); if (r) r.checked = true;
      tr.querySelector('.statusCell').textContent = 'absent';
    });
  });
  document.getElementById('refreshAttendanceBtn').addEventListener('click', loadAttendance);

  // ---------- Analytics Chart placeholder (Chart.js) ----------
  const ctx = document.getElementById('messagesChart')?.getContext?.('2d');
  if (ctx) {
    window.__messagesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['T-6','T-5','T-4','T-3','T-2','T-1','Now'],
        datasets: [{ label: 'Messages', data: [12,24,18,36,30,40,45], tension:0.3, fill:true }]
      },
      options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // ---------- Counter animation on page load ----------
  function animateCounter(element, start = 0, end = 0, duration = 1000) {
    let startTime = null;
    function step(currentTime) {
      if (!startTime) startTime = currentTime;
      const progress = Math.min((currentTime - startTime) / duration, 1);
      element.innerText = Math.floor(progress * (end - start) + start);
      if (progress < 1) window.requestAnimationFrame(step);
    }
    window.requestAnimationFrame(step);
  }
  document.addEventListener('DOMContentLoaded', ()=> {
    document.querySelectorAll('.counter').forEach((el)=>{
      const end = parseInt(el.getAttribute('data-count')||'0',10);
      animateCounter(el, 0, end, 1200);
    });
  });

  // expose API & socket for other modules
  window.API_URL = API_URL;
  window.socket = socket;
</script>

<!-- Keep your module imports (they can use window.API_URL / window.socket) -->
<script type="module" src="attendance.js"></script>
<script type="module" src="testManagement.js"></script>
<script type="module" src="userManagement.js"></script>
<script type="module" src="badge.js"></script>
<script type="module" src="chatbot.js"></script>
<script type="module" src="analytics.js"></script>
<script type="module" src="importExport.js"></script>
<script type="module" src="masterCommand.js"></script>
<script type="module" src="notice.js"></script>
<script type="module" src="profile.js"></script>
<script type="module" src="main.js"></script>

</body>
</html>
