<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="admin.css">
<link rel="stylesheet" href="chatbot.css">
<style>
/* Basic layout */
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  display: flex;
  height: 100vh;
  overflow: hidden;
}
.sidebar {
  width: 220px;
  background: #004aad;
  color: #fff;
  display: flex;
  flex-direction: column;
  padding-top: 20px;
  overflow-y: auto;
}
.sidebar button {
  background: transparent;
  border: none;
  color: #fff;
  padding: 12px 20px;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  transition: 0.3s;
}
.sidebar button:hover, .sidebar button.active {
  background: #006bff;
}
.mainContent {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #f4f6f9;
}
.admin-section {
  display: none;
  background: #fff;
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  animation: fadeIn 0.5s ease;
}
h2 { margin-top: 0; }
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(10px);}
  to {opacity: 1; transform: translateY(0);}
}
  </style>
</head>
<body>
  <!-- ğŸ”’ Token validation -->
  <script>
    (async () => {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("âš ï¸ Please login first!");
        window.location.href = "/login.html";
        return;
      }

      try {
        const res = await fetch("https://feathers-26g1.onrender.com/api/verify-token", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Invalid or expired token");
        const data = await res.json();
        console.log("âœ… Token verified:", data);
      } catch (err) {
        console.error("Token validation failed:", err.message);
        alert("Session expired. Please login again.");
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      }
    })();
  </script>

  <!-- âœ… Sidebar -->
  <div class="sidebar">
    <button class="menuBtn active" data-section="attendanceSection">ğŸ“‹ Attendance</button>
    <button class="menuBtn" data-section="testSection">ğŸ“š Test Management</button>
    <button class="menuBtn" data-section="userManagementSection">ğŸ‘¤ Users</button>
    <button class="menuBtn" data-section="badgeSection">ğŸ… Badges</button>
    <button class="menuBtn" data-section="chatbotAdminSection">ğŸ¤– Chatbot</button>
    <button class="menuBtn" data-section="analyticsSection">ğŸ“ˆ Analytics</button>
    <button class="menuBtn" data-section="importExportSection">ğŸ”„ Import/Export</button>
    <button class="menuBtn" data-section="masterCommandSection">âš¡ Master Command</button>
    <button class="menuBtn" data-section="noticeSection">ğŸ“¢ Notices</button>
    <button class="menuBtn" data-section="profileSection">ğŸ‘¤ Profile</button>
    <!-- ğŸŒ— Dark Mode Toggle -->
<div style="margin-top: 20px; padding: 0 20px;">
  <button id="themeToggleBtn" style="
    width:100%;
    background:#333;
    color:white;
    border:none;
    padding:12px 0;
    border-radius:8px;
    cursor:pointer;
    font-size:14px;
    transition:0.3s;
  ">ğŸŒ™ Dark Mode</button>
</div>

    <!-- ğŸ”’ Logout button -->
    <div style="margin-top:auto; padding:20px; border-top:1px solid rgba(255,255,255,0.2);">
      <button id="logoutBtn" style="
        width:100%;
        background:#ff3b3b;
        color:white;
        border:none;
        padding:12px 0;
        border-radius:8px;
        cursor:pointer;
        font-size:14px;
        transition:0.3s;
      ">ğŸšª Logout</button>
    </div>
  </div>

  <!-- âœ… Main Content -->
  <div class="mainContent">
    <!-- Attendance Section -->
    <div id="attendanceSection" class="admin-section">
      <h2>ğŸ“‹ Attendance Management</h2>
      <div class="attendance-controls">
        <label>Select Date:</label>
        <input type="date" id="attendanceDate" />
        <button onclick="markAllPresent()">Mark All Present</button>
        <button onclick="markAllAbsent()">Mark All Absent</button>
      </div>
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>Student</th>
            <th>Present</th>
            <th>Absent</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Test Management Section -->
    <div id="testSection" class="admin-section">
      <h2>ğŸ“ Test Management</h2>
      <!-- Your test content -->
    </div>
  </div>

  <!-- âœ… Logout handler -->
  <script>
    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", () => {
      if (confirm("Are you sure you want to logout?")) {
        const overlay = document.createElement("div");
        overlay.style.position = "fixed";
        overlay.style.top = 0;
        overlay.style.left = 0;
        overlay.style.width = "100%";
        overlay.style.height = "100%";
        overlay.style.background = "white";
        overlay.style.opacity = 0;
        overlay.style.transition = "opacity 0.5s ease";
        overlay.style.zIndex = 9999;
        document.body.appendChild(overlay);

        requestAnimationFrame(() => (overlay.style.opacity = 1));
        setTimeout(() => {
          localStorage.removeItem("token");
          window.location.href = "/login.html";
        }, 600);
      }
    });
  </script>
</body>
</html>


  <!-- Attendance Section -->
  <div id="attendanceSection" class="admin-section">
    <h2>ğŸ“‹ Attendance Management</h2>
    <div class="attendance-controls">
      <label>Select Date:</label>
      <input type="date" id="attendanceDate" />
      <button onclick="markAllPresent()">Mark All Present</button>
      <button onclick="markAllAbsent()">Mark All Absent</button>
    </div>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th>Student</</th>
          <th>Present</th>
          <th>Absent</th>
          <th>Late</th>
          <th>On Duty</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="saveAttendance()">ğŸ’¾ Save Attendance</button>
  </div>

  <!-- Test Section -->
  <div id="testSection" class="admin-section">
    <h2>ğŸ“ Test Management</h2>
    <form id="createTestForm">
      <label for="testTitle">Test Title:</label>
      <input type="text" id="testTitle" required>
      <label for="testSubject">Subject:</label>
      <input type="text" id="testSubject" required>
      <label for="testType">Test Type:</label>
      <select id="testType">
        <option value="mcq">MCQ</option>
        <option value="subjective">Subjective</option>
      </select>

      <div id="mcqSection" class="mcqContainer" style="display:none;">
        <label>Options:</label>
        <div id="optionContainer"></div>
        <button type="button" id="addOptionBtn">â• Add Option</button>
        <label>Correct Answer:</label>
        <select id="correctAnswerSelect"></select>
      </div>

      <label for="publishSelect">Publish To:</label>
      <select id="publishSelect">
        <option value="all">All Students</option>
        <option value="specific">Specific Students</option>
      </select>

      <div id="studentSelectContainer" style="display:none;">
        <label>Select Students:</label>
        <select id="studentSelect" multiple></select>
      </div>

      <button type="submit">Create & Publish Test</button>
    </form>

    <h3>Existing Tests</h3>
    <div class="testTableContainer">
      <table id="testTable">
        <thead>
          <tr>
            <th>Title</th>
            <th>Subject</th>
            <th>Type</th>
            <th>Published To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="confettiContainer"></div>
  </div>

  <!-- User Management -->
  <div id="userManagementSection" class="admin-section">
    <h2>ğŸ‘¤ User Management</h2>
    <form id="addUserForm">
      <input type="text" id="username" placeholder="Username" required>
      <input type="email" id="email" placeholder="Email" required>
      <select id="role">
        <option value="student">Student</option>
        <option value="faculty">Faculty</option>
        <option value="moderator">Moderator</option>
        <option value="tester">Tester</option>
      </select>
      <input type="password" id="password" placeholder="Password (if applicable)">
      <button type="submit">Add User</button>
    </form>

    <input type="text" id="profileSearchUser" placeholder="Search by username, email, or role...">

    <div class="userTableContainer">
      <table id="userTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Password</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Badge Section -->
  <div id="badgeSection" class="admin-section">
    <h2>ğŸ… Badge Management</h2>
    <form id="addBadgeForm">
      <label>Badge Name:</label>
      <input type="text" id="badgeName" required>

      <label>Effects (visual):</label>
      <select id="badgeEffects" multiple>
        <option value="glow">Glow</option>
        <option value="spin">Spin</option>
        <option value="rainbow">Rainbow</option>
        <option value="bounce">Bounce</option>
        <option value="shadow">Shadow</option>
        <option value="pulse">Pulse</option>
      </select>

      <label>Special Access (permissions):</label>
      <select id="badgeAccess" multiple>
        <option value="editAttendance">Edit Attendance</option>
        <option value="editTests">Edit Tests</option>
        <option value="manageUsers">Manage Users</option>
        <option value="accessMasterCommand">Master Command</option>
        <option value="sendGlobalMessage">Send Global Messages</option>
      </select>

      <button type="submit">Create Badge</button>
    </form>

    <div id="badgeList"></div>

    <h3>Assign Badge to User</h3>
    <select id="assignBadgeUser"><option value="">Select User</option></select>
    <select id="assignBadgeSelect"><option value="">Select Badge</option></select>
    <button id="assignBadgeBtn">Assign Badge</button>

    <div id="badgeStatus"></div>
  </div>

  <!-- Chatbot Section -->
  <div id="chatbotAdminSection" class="admin-section">
    <h2>ğŸ¤– Chatbot Trigger Management</h2>
    <button onclick="promptAddTrigger()">â• Add New Trigger</button>
    <div id="triggerList"></div>
  </div>

  <div id="chatbotOverlay">
    <div id="chatbotMessage">Chatbot Locked</div>
  </div>

  <div class="chatbot-container" id="studentChatbot" style="display:none;">
    <div class="chatbot-header">Student Chatbot</div>
    <div class="chatbot-messages" id="studentMessages"></div>
    <div class="chatbot-input-area">
      <input type="text" id="studentInput" placeholder="Type your message...">
      <button onclick="studentSendMessage(document.getElementById('studentInput').value)">Send</button>
    </div>
  </div>

  <!-- Analytics Section -->
  <div id="analyticsSection" class="admin-section">
    <h2>ğŸ“ˆ Analytics Management</h2>
    <div class="analytics-cards">
      <div class="card"><h3>Total Messages</h3><p id="totalMessages">0</p></div>
      <div class="card"><h3>Active Users</h3><p id="activeUsers">0</p></div>
      <div class="card"><h3>Chatbot Locks</h3><p id="lockCount">0</p></div>
      <div class="card"><h3>Total Lock Duration (mins)</h3><p id="lockDuration">0</p></div>
    </div>
    <div class="analytics-cards">
      <div class="card"><h3>Most Used Trigger</h3><p id="topTrigger">None</p></div>
      <div class="card"><h3>Urgent Alerts</h3><p id="urgentCount">0</p></div>
      <div class="card"><h3>Warnings</h3><p id="warningCount">0</p></div>
      <div class="card"><h3>Normal Messages</h3><p id="normalCount">0</p></div>
    </div>
    <canvas id="messagesChart"></canvas>
  </div>

  <!-- Import/Export Section -->
  <div id="importExportSection" class="admin-section">
    <h2>ğŸ”„ Import & Export Management</h2>
    <div class="importExportContainer">
      <div class="exportBox">
        <h3>ğŸ“¤ Export Data</h3>
        <button class="btn btn-primary" onclick="exportAllData()">Export All JSON</button>
      </div>
      <div class="importBox">
        <h3>ğŸ“¥ Import Data</h3>
        <input type="file" id="importFile" accept=".json">
        <button class="btn btn-success" onclick="importAllData()">Import JSON</button>
      </div>
    </div>
    <div id="importExportLog" class="logBox"></div>
  </div>

  <!-- Master Command Section -->
  <div id="masterCommandSection" class="admin-section">
    <h2>âš¡ Master Command System</h2>
    <div id="adminControls" style="display:none;">
      <button id="createCommandBtn">â• Create Command</button>
      <button id="lockUsersBtn" onclick="lockAllUsers(30)">ğŸ”’ Lock Users</button>
    </div>
    <div id="commandInputContainer">
      <input type="text" id="masterCommandInput" placeholder="Type command name and press Enter">
    </div>
    <div class="container">
      <div id="masterList"></div>
    </div>
    <div id="globalLockOverlay">
      <div class="lockContainer">
        <div class="lockIcon">ğŸ”’</div>
        <div class="lockMessage" id="lockMessage">All Users Locked</div>
        <div class="countdownTimer" id="countdownTimer">Unlock in 30 sec</div>
      </div>
    </div>
  </div>

  <!-- Notice Section -->
  <div id="noticeSection" class="admin-section">
    <h2>ğŸ“¢ Notice Management</h2>
    <form id="addNoticeForm">
      <label>Title:</label>
      <input type="text" id="noticeTitle" required>
      <label>Message:</label>
      <textarea id="noticeMessage" rows="3" required></textarea>
      <label>Publish To:</label>
      <select id="noticePublishSelect">
        <option value="all">All Students</option>
        <option value="specific">Specific Students</option>
      </select>
      <div id="noticeStudentContainer" style="display:none;">
        <label>Select Students:</label>
        <select id="noticeStudentSelect" multiple></select>
      </div>
      <button type="submit">Publish Notice</button>
    </form>
    <div class="noticeTableContainer">
      <table id="noticeTable">
        <thead>
          <tr>
            <th>Title</th>
            <th>Message</th>
            <th>Published To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Profile Section -->
  <div id="profileSection" class="admin-section">
    <h2>ğŸ‘¤ User Profile Management</h2>
    <input type="text" id="profileSearch" placeholder="Search by username, name, or email...">
    <div class="profileTableContainer">
      <table id="profileTable">
        <thead>
          <tr>
            <th>Avatar</th>
            <th>Username</th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Badges</th>
            <th>Special Access</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div> <!-- End mainContent -->

<!-- ===========================
     JS & Modules
=========================== -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ğŸ”— Global backend URL for all modules
  window.API_URL = "https://feathers-26g1.onrender.com";
</script>

<script type="module" src="attendance.js"></script>
<script type="module" src="testManagement.js"></script>
<script type="module" src="userManagement.js"></script>
<script type="module" src="badge.js"></script>
<script type="module" src="chatbot.js"></script>
<script type="module" src="analytics.js"></script>
<script type="module" src="importExport.js"></script>
<script type="module" src="masterCommand.js"></script>
<script type="module" src="notice.js"></script>
<script type="module" src="profile.js"></script>
<script type="module" src="main.js"></script>

<script>
const menuBtns = document.querySelectorAll('.menuBtn');
const sections = document.querySelectorAll('.admin-section');
menuBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    menuBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const target = btn.dataset.section;
    sections.forEach(sec=>{
      sec.style.display = (sec.id === target) ? 'block' : 'none';
    });
  });
});
sections.forEach((sec, idx)=>{ sec.style.display = (idx===0) ? 'block' : 'none'; });
</script>

</body>
</html>
