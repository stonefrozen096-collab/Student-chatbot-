<script>
const API_URL = "https://feathers-26g1.onrender.com";

const requestTokenBtn = document.getElementById("requestTokenBtn");
const resetPasswordBtn = document.getElementById("resetPasswordBtn");
const requestTokenMsg = document.getElementById("requestTokenMsg");
const resetPasswordMsg = document.getElementById("resetPasswordMsg");

// ---------- Step 1: Request Reset Code ----------
requestTokenBtn.addEventListener("click", async (e) => {
  e.preventDefault(); // ✅ Prevent accidental reload
  const email = document.getElementById("email").value.trim();
  if (!email) return alert("Enter your email");

  requestTokenMsg.textContent = "⏳ Sending code...";
  requestTokenMsg.style.color = "#555";

  try {
    const res = await fetch(`${API_URL}/api/request-reset`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    const data = await res.json();
    console.log("Reset API response:", data);

    if (!data.ok) throw new Error(data.error || "Failed to send code");

    requestTokenMsg.textContent = "✅ Code sent to your email!";
    requestTokenMsg.style.color = "green";
  } catch (err) {
    console.error("Reset error:", err);
    requestTokenMsg.textContent = `❌ ${err.message}`;
    requestTokenMsg.style.color = "red";
  }
});

// ---------- Step 2: Reset Password ----------
resetPasswordBtn.addEventListener("click", async (e) => {
  e.preventDefault(); // ✅ Prevent accidental reload
  const email = document.getElementById("resetEmail").value.trim();
  const code = document.getElementById("resetCode").value.trim();
  const newPassword = document.getElementById("newPassword").value.trim();

  if (!email || !code || !newPassword)
    return alert("Please fill all fields");

  resetPasswordMsg.textContent = "⏳ Resetting password...";
  resetPasswordMsg.style.color = "#555";

  try {
    const res = await fetch(`${API_URL}/api/reset-password`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, code, newPassword })
    });

    const data = await res.json();
    console.log("Password reset response:", data);

    if (!data.ok) throw new Error(data.error || "Reset failed");

    resetPasswordMsg.textContent = "✅ Password reset successful! Redirecting...";
    resetPasswordMsg.style.color = "green";

    setTimeout(() => (window.location.href = "login.html"), 2000);
  } catch (err) {
    console.error("Reset password error:", err);
    resetPasswordMsg.textContent = `❌ ${err.message}`;
    resetPasswordMsg.style.color = "red";
  }
});
</script>
