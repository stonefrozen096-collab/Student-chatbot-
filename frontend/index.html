<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Assistant — Login</title>
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/animation.css">
</head>
<body>
  <div class="container">
    <h1>Student Assistant</h1>

    <!-- Login / Signup -->
    <section id="auth-section">
      <input type="text" id="authName" placeholder="Full Name (for signup)">
      <input type="email" id="authEmail" placeholder="Email">
      <input type="password" id="authPassword" placeholder="Password">
      <button id="loginBtn">Login</button>
      <button id="signupBtn">Sign Up</button>
      <p><a href="#" id="forgotLink">Forgot Password?</a></p>
      <p id="authMsg" class="feedback-msg"></p>
    </section>

    <!-- Forgot Password -->
    <section id="forgot-section" style="display:none">
      <h2>Forgot Password</h2>
      <input type="email" id="fpEmail" placeholder="Registered Email">
      <button id="sendTokenBtn">Send Reset Token</button>
      <p id="fpMsg"></p>
      <p><a href="#" id="backToAuth">Back</a></p>
    </section>

    <!-- Reset Password -->
    <section id="reset-section" style="display:none">
      <h2>Reset Password</h2>
      <input type="text" id="resetToken" placeholder="Enter token">
      <input type="password" id="newPassword" placeholder="New Password">
      <input type="password" id="confirmPassword" placeholder="Confirm Password">
      <button id="resetBtn">Reset Password</button>
      <p id="resetMsg"></p>
    </section>
  </div>

  <script>
    const authSection = document.getElementById('auth-section');
    const forgotSection = document.getElementById('forgot-section');
    const resetSection = document.getElementById('reset-section');

    const authMsg = document.getElementById('authMsg');
    const fpMsg = document.getElementById('fpMsg');
    const resetMsg = document.getElementById('resetMsg');

    // Toggle sections
    document.getElementById('forgotLink').addEventListener('click', () => {
      authSection.style.display = 'none';
      forgotSection.style.display = 'block';
    });
    document.getElementById('backToAuth').addEventListener('click', () => {
      forgotSection.style.display = 'none';
      resetSection.style.display = 'none';
      authSection.style.display = 'block';
    });

    // ------------------- Login -------------------
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      authMsg.textContent = '';

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (res.ok) {
          authMsg.style.color = 'green';
          authMsg.textContent = '✅ Login successful! Redirecting...';
          setTimeout(() => window.location.href = 'dashboard.html', 1000);
        } else {
          authMsg.style.color = 'red';
          authMsg.textContent = data.error || 'Login failed';
        }
      } catch (err) {
        authMsg.style.color = 'red';
        authMsg.textContent = 'Error connecting to server.';
      }
    });

    // ------------------- Signup -------------------
    document.getElementById('signupBtn').addEventListener('click', async () => {
      const name = document.getElementById('authName').value.trim();
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      authMsg.textContent = '';

      if (!name || !email || !password) {
        authMsg.style.color = 'red';
        authMsg.textContent = 'All fields are required for signup.';
        return;
      }

      try {
        const res = await fetch('/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });
        const data = await res.json();
        if (!data.error) {
          authMsg.style.color = 'green';
          authMsg.textContent = '✅ Signup successful! You can login now.';
          document.getElementById('authName').value = '';
          document.getElementById('authPassword').value = '';
        } else {
          authMsg.style.color = 'red';
          authMsg.textContent = data.error;
        }
      } catch (err) {
        authMsg.style.color = 'red';
        authMsg.textContent = 'Error connecting to server.';
      }
    });

    // ------------------- Forgot Password -------------------
    document.getElementById('sendTokenBtn').addEventListener('click', async () => {
      const email = document.getElementById('fpEmail').value.trim();
      fpMsg.textContent = '';
      try {
        const res = await fetch('/admin/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        fpMsg.style.color = res.ok ? 'green' : 'red';
        fpMsg.textContent = data.msg;
        if (res.ok) resetSection.style.display = 'block';
      } catch (err) {
        fpMsg.style.color = 'red';
        fpMsg.textContent = 'Error sending request.';
      }
    });

    // ------------------- Reset Password -------------------
    document.getElementById('resetBtn').addEventListener('click', async () => {
      const token = document.getElementById('resetToken').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();

      resetMsg.textContent = '';

      if (newPassword !== confirmPassword) {
        resetMsg.style.color = 'red';
        resetMsg.textContent = 'Passwords do not match.';
        return;
      }

      try {
        const res = await fetch('/admin/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, newPassword })
        });
        const data = await res.json();
        resetMsg.style.color = res.ok ? 'green' : 'red';
        resetMsg.textContent = data.msg;
        if (res.ok) {
          document.getElementById('resetToken').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
        }
      } catch (err) {
        resetMsg.style.color = 'red';
        resetMsg.textContent = 'Error resetting password.';
      }
    });
  </script>
</body>
</html>
