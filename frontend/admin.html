<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Assistant Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1724; --accent:#4f46e5; --accent-2:#3b82f6;
      --muted:#9aa7b2; --glass: rgba(255,255,255,0.03);
    }
    [data-theme="light"]{
      --bg:#f9f9f9; --card:#fff; --accent:#4f46e5; --accent-2:#3b82f6;
      --muted:#555; --glass: rgba(0,0,0,0.03); color:#111;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,Arial;
      background:var(--bg); color:#e6eef6;}
    .wrap{max-width:1180px;margin:28px auto;padding:18px;position:relative;z-index:2}
    h1{margin:0 0 12px;font-weight:600;color:var(--accent)}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    .card{background:var(--card);border-radius:12px;padding:18px;
      box-shadow:0 8px 30px rgba(3,7,18,0.6);border:1px solid rgba(255,255,255,0.02)}
    label{display:block;margin-top:10px;font-size:13px;color:#cfe6ff}
    input, textarea, select{width:100%;padding:9px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:#eaf4ff;margin-top:6px;}
    textarea{resize:vertical;min-height:72px;}
    .btn{display:inline-block;padding:9px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#dff0ff}
    .btn-danger{background:#ef4444;color:white}
    .tiny{font-size:12px;padding:6px 8px}
    .small{font-size:13px;color:var(--muted)}
    .space{height:10px}
    .inline{display:flex;gap:8px;align-items:center}
    .list{margin-top:12px;max-height:240px;overflow:auto;padding-right:6px}
    canvas{max-width:100%;height:auto}
    .summary-card{padding:12px;border-radius:12px;background:var(--card);text-align:center}
    .summary-card h4{margin:0;color:var(--accent)}
  </style>
</head>
<body data-theme="dark">
<canvas id="bg-canvas" aria-hidden="true"></canvas>

<div class="wrap">
  <!-- HEADER -->
  <div class="row" style="align-items:center;justify-content:space-between">
    <div>
      <h1>Admin Dashboard — Student Assistant</h1>
      <div class="small">Manage users, badges, attendance, tests, analytics and logs</div>
    </div>
    <div class="inline">
      <button class="btn btn-ghost tiny" onclick="toggleTheme()">Toggle Theme</button>
    </div>
  </div>
  <div class="space"></div>

  <!-- SUMMARY CARDS -->
  <div class="row">
    <div class="col summary-card">
      <h4>Average Attendance</h4>
      <div id="avgAttendance">0%</div>
    </div>
    <div class="col summary-card">
      <h4>Average Marks</h4>
      <div id="avgMarks">0</div>
    </div>
    <div class="col summary-card">
      <h4>Top Student</h4>
      <div id="topStudent">N/A</div>
    </div>
  </div>

  <div class="space"></div>

  <!-- ROW 1: Users -->
  <div class="row">
    <div class="col card">
      <h3>User Management</h3>
      <input type="text" class="search-input" placeholder="Search users..." oninput="renderUsers()">
      <form id="createUserForm">
        <label>Role</label>
        <select id="newUserRole">
          <option value="admin">Admin</option>
          <option value="moderator">Moderator</option>
          <option value="tester">Tester</option>
          <option value="faculty">Faculty</option>
          <option value="student">Student</option>
        </select>
        <label>Username / Email</label>
        <input type="text" id="newUserName" placeholder="example@domain.com or REG123" required>
        <label>Password (optional)</label>
        <input type="password" id="newUserPassword" placeholder="password (optional)">
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-primary" type="submit">Create user</button>
          <button class="btn btn-ghost" type="button" onclick="exportData()">Export JSON</button>
          <button class="btn btn-ghost" type="button" onclick="importDataPrompt()">Import JSON</button>
        </div>
      </form>
      <div class="space"></div>
      <div class="small">Existing users</div>
      <div class="list">
        <table id="usersTable">
          <thead><tr><th>User</th><th>Role</th><th>Badges</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="space"></div>
      <label>Delete user</label>
      <div class="inline">
        <select id="deleteUserSelect"></select>
        <button class="btn btn-danger tiny" onclick="deleteUser()">Delete</button>
      </div>
    </div>
    <!-- BADGES & BATCHES -->
    <div class="col card">
      <h3>Badge & Batch Management</h3>
      <label>Assign badge</label>
      <div class="inline">
        <select id="badgeUserSelect"></select>
        <select id="badgeRoleSelect">
          <option value="admin">Admin</option>
          <option value="moderator">Moderator</option>
          <option value="tester">Tester</option>
          <option value="faculty">Faculty</option>
          <option value="student">Student</option>
        </select>
        <button class="btn btn-primary tiny" onclick="assignBadge()">Assign</button>
      </div>

      <label>Remove badge</label>
      <div class="inline">
        <select id="deleteBadgeUser"></select>
        <select id="badgeRoleSelectRemove">
          <option value="admin">Admin</option>
          <option value="moderator">Moderator</option>
          <option value="tester">Tester</option>
          <option value="faculty">Faculty</option>
          <option value="student">Student</option>
        </select>
        <button class="btn btn-danger tiny" onclick="removeBadge()">Remove</button>
      </div>

      <div class="space"></div>
      <label>Batches</label>
      <div class="inline">
        <select id="batchSelect"></select>
        <button class="btn btn-danger tiny" onclick="deleteBatch()">Delete Batch</button>
      </div>
    </div>
  </div>

  <div class="space"></div>

  <!-- ROW 2: Academic | Attendance | Tests -->
  <div class="row">
    <!-- Academic -->
    <div class="col card">
      <h3>Academic items</h3>
      <input type="text" class="search-input" placeholder="Search academic..." oninput="renderAcademic()">
      <form id="acadForm">
        <label>Type</label>
        <select id="acadType">
          <option value="note">Note</option>
          <option value="assignment">Assignment</option>
          <option value="notice">Notice</option>
        </select>
        <label>Title/Subject</label>
        <input id="acadTitle" type="text" placeholder="Title or subject">
        <label>Content</label>
        <textarea id="acadContent" placeholder="Content..."></textarea>
        <label>Assign to student (optional)</label>
        <select id="acadStudentSelect"><option value="">All students</option></select>
        <div class="inline" style="margin-top:10px; gap:8px">
          <button class="btn btn-primary" type="submit">Add item</button>
          <button class="btn btn-ghost" type="button" onclick="renderAcademic()">Refresh</button>
        </div>
      </form>
      <div class="space"></div>
      <div class="small">Academic list</div>
      <div id="academicList" class="list"></div>
    </div>

    <!-- Attendance -->
    <div class="col card">
      <h3>Attendance</h3>
      <input type="text" class="search-input" placeholder="Search attendance..." oninput="renderAttendance()">
      <form id="attendanceForm">
        <label>Subject name</label>
        <input id="attendanceSubject" type="text" placeholder="e.g. Mathematics" required>
        <label>Percentage</label>
        <input id="attendancePercent" type="number" min="0" max="100" placeholder="80" required>
        <div class="inline" style="margin-top:10px; gap:8px">
          <button class="btn btn-primary" type="submit">Add / Update</button>
          <button class="btn btn-ghost" type="button" onclick="renderAttendance()">Refresh</button>
        </div>
      </form>
      <div class="space"></div>
      <div class="small">Attendance list</div>
      <div id="attendanceList" class="list"></div>
      <div class="space"></div>
      <label>Delete subject</label>
      <div class="inline">
        <select id="deleteSubjectSelect"></select>
        <button class="btn btn-danger tiny" onclick="deleteSubject()">Delete</button>
      </div>
    </div>

    <!-- Tests -->
    <div class="col card">
      <h3>Test Scores</h3>
      <input type="text" class="search-input" placeholder="Search tests..." oninput="renderTests()">
      <form id="testForm">
        <label>Subject</label>
        <input id="testSubject" type="text" placeholder="e.g. Physics" required>
        <label>Marks</label>
        <input id="testMarks" type="number" min="0" max="100" placeholder="75" required>
        <div class="inline" style="margin-top:10px; gap:8px">
          <button class="btn btn-primary" type="submit">Add / Update test</button>
          <button class="btn btn-ghost" type="button" onclick="renderTests()">Refresh</button>
        </div>
      </form>
      <div class="space"></div>
      <div class="small">Test list</div>
      <div id="testList" class="list"></div>
      <div class="space"></div>
      <label>Delete test</label>
      <div class="inline">
        <select id="deleteTestSelect"></select>
        <button class="btn btn-danger tiny" onclick="deleteTest()">Delete</button>
      </div>
    </div>
  </div>

  <div class="space"></div>

  <!-- ROW 3: Charts + Feedback + Logs -->
  <div class="row">
    <div class="col card">
      <h3>Attendance Chart</h3>
      <canvas id="attendanceChart"></canvas>
      <div class="inline" style="margin-top:8px; gap:8px">
        <select id="chartEditSubject"></select>
        <input id="chartEditValue" type="number" min="0" max="100" placeholder="%"/>
        <button class="btn btn-primary tiny" onclick="applyChartEdit()">Update</button>
      </div>
    </div>
    <div class="col card">
      <h3>Test Chart</h3>
      <canvas id="testChart"></canvas>
      <div class="inline" style="margin-top:8px; gap:8px">
        <select id="chartEditTest"></select>
        <input id="chartEditTestValue" type="number" min="0" max="100" placeholder="marks"/>
        <button class="btn btn-primary tiny" onclick="applyTestEdit()">Update</button>
      </div>
    </div>
    <div class="col card">
      <h3>Feedback & Trigger Logs</h3>
      <div id="feedbackList" class="list muted-block">No feedback yet</div>
      <div class="space"></div>
      <h3>Action Logs</h3>
      <div id="actionLogs" class="list"></div>
    </div>
  </div>

  <div class="space"></div>

  <!-- STUDENT LOGIN PROMPT -->
  <div class="col card">
    <h3>Student Dashboard</h3>
    <div class="inline">
      <input type="text" id="studentLogin" placeholder="Enter student username">
      <button class="btn btn-primary tiny" onclick="studentLogin()">Login</button>
      <button class="btn btn-ghost tiny" onclick="studentLogout()">Logout</button>
    </div>
  </div>
  <script>
/* ---------- Persistence ---------- */
const STORAGE_KEY = 'student_assistant_data_v2';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

// Default state
const defaultState = {
  admin: { name:'Admin', email:'admin@example.com' },
  users: [],
  batches: Array.from({length:20}, (_,i)=>i+1),
  academic: [],
  attendance: [],
  tests: [],
  feedback: [],
  logs: [],
  triggerWords: ['urgent','immediately','fail','help','issue'] // example triggers
};

// Ensure state keys
state = Object.assign({}, defaultState, state);

/* ---------- Helpers ---------- */
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function addLog(msg){ 
  const t = new Date().toISOString();
  state.logs.unshift(`${t} — ${msg}`);
  if(state.logs.length>500) state.logs.length=500;
  saveState(); renderAll();
}
function triggerCheck(text, source){
  const triggers = state.triggerWords || [];
  triggers.forEach(word=>{
    if(text.toLowerCase().includes(word.toLowerCase())){
      addLog(`Trigger word "${word}" detected in ${source}`);
    }
  });
}

/* ---------- Theme ---------- */
function toggleTheme(){
  const html = document.documentElement;
  html.classList.toggle('dark');
  addLog('Theme toggled');
}

/* ---------- Analytics cards ---------- */
function renderAnalytics(){
  const avgAtt = state.attendance.length ? (state.attendance.reduce((a,b)=>a+b.percent,0)/state.attendance.length).toFixed(2) : 0;
  const avgTest = state.tests.length ? (state.tests.reduce((a,b)=>a+b.marks,0)/state.tests.length).toFixed(2) : 0;
  let topStudent = '-';
  const studentScores = state.users.filter(u=>u.role==='student').map(s=>{
    const studentTests = state.tests.filter(t=>t.student===s.username);
    const avg = studentTests.length ? studentTests.reduce((a,b)=>a+b.marks,0)/studentTests.length : 0;
    return { username: s.username, avg };
  });
  if(studentScores.length) topStudent = studentScores.reduce((a,b)=>a.avg>b.avg?a:b).username;
  document.getElementById('analyticsCards').innerHTML = `
    <div class="analytics-card">Avg Attendance: ${avgAtt}%</div>
    <div class="analytics-card">Avg Test Marks: ${avgTest}</div>
    <div class="analytics-card">Top Student: ${topStudent}</div>
  `;
}

/* ---------- Student login ---------- */
let loggedStudent = null;
function studentLogin(){
  const val = document.getElementById('studentLogin').value.trim();
  if(!val) return alert('Enter username');
  const u = state.users.find(x=>x.username===val && x.role==='student');
  if(!u) return alert('Student not found');
  loggedStudent = u.username;
  addLog(`Student ${loggedStudent} logged in`);
  renderAll();
}
function studentLogout(){
  loggedStudent = null;
  document.getElementById('studentLogin').value='';
  addLog('Student logged out');
  renderAll();
}

/* ---------- Render functions ---------- */
function renderAll(){
  renderUsers();
  renderBatchSelect();
  renderBadgeUserSelects();
  renderAcademic();
  renderAttendance();
  renderTests();
  renderCharts();
  renderFeedback();
  renderLogs();
  renderAnalytics();
}

/* ---------- Users ---------- */
function renderUsers(){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML='';
  let users = state.users;
  if(loggedStudent) users = users.filter(u=>u.username===loggedStudent);
  const search = document.querySelector('#usersSearch')?.value?.toLowerCase() || '';
  users.filter(u=>u.username.toLowerCase().includes(search) || u.role.toLowerCase().includes(search)).forEach(u=>{
    const tr = document.createElement('tr');
    const badgesHTML = (u.badges||[]).map(b=>`<span class="badge badge-${b}">${b.toUpperCase()}</span>`).join(' ');
    tr.innerHTML = `<td>${u.username}</td><td>${u.role}</td><td>${badgesHTML}</td>
      <td>${!loggedStudent?`<button class="btn tiny btn-ghost" onclick="showEditUser('${u.username.replace(/'/g,"\\'")}')">Edit</button>
      <button class="btn tiny btn-danger" onclick="deleteUserByName('${u.username.replace(/'/g,"\\'")}')">Delete</button>`:''}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Academic ---------- */
function renderAcademic(){
  const c = document.getElementById('academicList');
  c.innerHTML='';
  let items = state.academic;
  if(loggedStudent) items = items.filter(a=>!a.student || a.student===loggedStudent);
  const search = document.querySelector('#acadSearch')?.value?.toLowerCase() || '';
  items.filter(a=>a.title.toLowerCase().includes(search) || a.content.toLowerCase().includes(search)).forEach(a=>{
    const div = document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>[${a.type.toUpperCase()}]</strong> ${a.title} 
      <div class="small">${a.student ? 'For: '+a.student : 'For: All'}</div>
      <div style="margin-top:6px">${a.content}</div>
      <div style="margin-top:6px">
        ${!loggedStudent?`<button class="btn tiny btn-ghost" onclick="editAcademic('${a.id}')">Edit</button>
        <button class="btn tiny btn-danger" onclick="deleteAcademic('${a.id}')">Delete</button>`:''}
      </div>`;
    c.appendChild(div);
  });
}

/* ---------- Attendance ---------- */
function renderAttendance(){
  const c = document.getElementById('attendanceList');
  c.innerHTML='';
  let items = state.attendance;
  const search = document.querySelector('#attSearch')?.value?.toLowerCase() || '';
  items.filter(a=>a.subject.toLowerCase().includes(search)).forEach(a=>{
    const div = document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>${a.subject}</strong> — ${a.percent}% 
      <div style="margin-top:6px">
        ${!loggedStudent?`<button class="btn tiny btn-ghost" onclick="promptEditAttendance('${a.subject}')">Edit</button>
        <button class="btn tiny btn-danger" onclick="deleteSubjectByName('${a.subject}')">Delete</button>`:''}
      </div>`;
    c.appendChild(div);
  });
}

/* ---------- Tests ---------- */
function renderTests(){
  const c = document.getElementById('testList');
  c.innerHTML='';
  let items = state.tests;
  if(loggedStudent) items = items.filter(t=>t.student===loggedStudent);
  const search = document.querySelector('#testSearch')?.value?.toLowerCase() || '';
  items.filter(t=>t.subject.toLowerCase().includes(search)).forEach(t=>{
    const div = document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>${t.subject}</strong> — ${t.marks} 
      <div style="margin-top:6px">
        ${!loggedStudent?`<button class="btn tiny btn-ghost" onclick="promptEditTest('${t.subject}')">Edit</button>
        <button class="btn tiny btn-danger" onclick="deleteTestByName('${t.subject}')">Delete</button>`:''}
      </div>`;
    c.appendChild(div);
  });
}

/* ---------- Charts ---------- */
let attendanceChart=null, testChart=null;
function renderCharts(){
  const attCtx = document.getElementById('attendanceChart').getContext('2d');
  const testCtx = document.getElementById('testChart').getContext('2d');

  const attLabels = (state.attendance||[]).map(a=>a.subject);
  const attData = (state.attendance||[]).map(a=>a.percent);
  const testLabels = (state.tests||[]).map(t=>t.subject);
  const testData = (state.tests||[]).map(t=>t.marks);

  if(attendanceChart){
    attendanceChart.data.labels = attLabels;
    attendanceChart.data.datasets[0].data = attData;
    attendanceChart.update();
  } else {
    attendanceChart = new Chart(attCtx,{
      type:'bar',
      data:{ labels:attLabels, datasets:[{label:'Attendance %', data:attData, backgroundColor:'#4f46e5'}]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  }

  if(testChart){
    testChart.data.labels = testLabels;
    testChart.data.datasets[0].data = testData;
    testChart.update();
  } else {
    testChart = new Chart(testCtx,{
      type:'bar',
      data:{ labels:testLabels, datasets:[{label:'Test marks', data:testData, backgroundColor:'#3b82f6'}]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  }
}

/* ---------- Feedback ---------- */
function renderFeedback(){
  const c = document.getElementById('feedbackList');
  if(!state.feedback.length){ c.innerHTML='<div class="small muted">No feedback yet</div>'; return; }
  c.innerHTML = state.feedback.map(f=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">${f}</div>`).join('');
}

/* ---------- Logs ---------- */
function renderLogs(){
  document.getElementById('actionLogs').innerHTML = state.logs.map(l=>`<div style="padding:6px">${l}</div>`).join('');
}

/* ---------- Init ---------- */
renderAll();
window._sa_state = state;
  </script>
