<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="Admin.css">
<link rel="stylesheet" href="Animation.css">
<link rel="stylesheet" href="Common.css">
<style>
  /* Extra inline tweaks if needed */
  .card { padding:16px; margin:12px 0; border-radius:12px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.08);}
  .btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer;}
  .btn-primary { background:#4f46e5; color:white;}
  .btn-danger { background:#ef4444; color:white;}
  .btn-ghost { background:transparent; border:1px solid #ccc;}
  .list { margin-top:10px; max-height:300px; overflow-y:auto; }
  input, select, textarea { width:100%; padding:6px; margin:4px 0 10px 0; border-radius:6px; border:1px solid #ccc;}
</style>
</head>
<body>
<div class="container">

  <!-- ===== USER MANAGEMENT ===== -->
  <div class="card">
    <h2>User Management</h2>
    <form id="addUserForm">
      <label>Username</label>
      <input type="text" id="userName" placeholder="Enter username" required>
      
      <label>Role</label>
      <select id="userRole">
        <option value="student">Student</option>
        <option value="faculty">Faculty</option>
        <option value="moderator">Moderator</option>
        <option value="tester">Tester</option>
      </select>

      <label>Password (for Faculty only)</label>
      <input type="password" id="userPassword" placeholder="Enter password">

      <button type="submit" class="btn btn-primary">Add User</button>
    </form>
    
    <div class="muted small">Current Users</div>
    <div id="userList" class="list"></div>
  </div>

  <!-- ===== BADGE MANAGEMENT ===== -->
  <div class="card">
    <h2>Badge Management</h2>
    <form id="addBadgeForm">
      <label>Badge Name</label>
      <input type="text" id="badgeName" placeholder="Enter badge name" required>

      <label>Description / Purpose</label>
      <input type="text" id="badgeDesc" placeholder="Enter badge description">

      <label>Special Access?</label>
      <select id="badgeAccess">
        <option value="none">No</option>
        <option value="yes">Yes</option>
      </select>

      <label>Effect</label>
      <select id="badgeEffect">
        <option value="none">None</option>
        <option value="glow">Glow</option>
        <option value="sparkle">Sparkle</option>
        <option value="bounce">Bounce</option>
      </select>

      <button type="submit" class="btn btn-primary">Add Badge</button>
    </form>

    <div class="muted small">Current Badges</div>
    <div id="badgeList" class="list"></div>
  </div>

</div>

<script src="Main.js"></script>
<script>
// ===== JavaScript for Part 1 =====

let state = {
  users: [],
  badges: []
};

/* ---------- USER MANAGEMENT ---------- */
document.getElementById('addUserForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('userName').value.trim();
  const role = document.getElementById('userRole').value;
  const password = document.getElementById('userPassword').value;

  if(role==='faculty' && !password){ alert('Password required for Faculty'); return; }

  state.users.push({username:name, role, password, badges:[]});
  renderUsers();
  document.getElementById('addUserForm').reset();
});

function renderUsers(){
  const c=document.getElementById('userList');
  c.innerHTML='';
  state.users.forEach((u,i)=>{
    const div=document.createElement('div');
    div.style.padding='6px'; div.style.borderBottom='1px solid rgba(0,0,0,0.1)';
    div.innerHTML=`
      <strong>${u.username}</strong> | ${u.role} | Badges: ${u.badges.join(', ') || '-'}
      <button class="btn tiny btn-ghost" onclick="editUser(${i})">Edit</button>
      <button class="btn tiny btn-danger" onclick="deleteUser(${i})">Delete</button>
    `;
    c.appendChild(div);
  });
}

function editUser(i){
  const u=state.users[i];
  const newName = prompt('Username', u.username); if(newName!==null) u.username=newName;
  const newRole = prompt('Role', u.role); if(newRole!==null) u.role=newRole;
  const newPass = prompt('Password', u.password||''); if(newPass!==null) u.password=newPass;
  renderUsers();
}

function deleteUser(i){
  if(!confirm('Delete this user?')) return;
  state.users.splice(i,1);
  renderUsers();
}

/* ---------- BADGE MANAGEMENT ---------- */
document.getElementById('addBadgeForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('badgeName').value.trim();
  const desc = document.getElementById('badgeDesc').value.trim();
  const access = document.getElementById('badgeAccess').value;
  const effect = document.getElementById('badgeEffect').value;

  state.badges.push({name, desc, specialAccess: access, effect});
  renderBadges();
  document.getElementById('addBadgeForm').reset();
});

function renderBadges(){
  const c=document.getElementById('badgeList');
  c.innerHTML='';
  state.badges.forEach((b,i)=>{
    const div=document.createElement('div');
    div.style.padding='6px'; div.style.borderBottom='1px solid rgba(0,0,0,0.1)';
    div.innerHTML=`
      <strong>${b.name}</strong> | Access: ${b.specialAccess} | Effect: ${b.effect}
      <button class="btn tiny btn-ghost" onclick="editBadge(${i})">Edit</button>
      <button class="btn tiny btn-danger" onclick="deleteBadge(${i})">Delete</button>
    `;
    c.appendChild(div);
  });
}

function editBadge(i){
  const b=state.badges[i];
  const newName=prompt('Badge Name', b.name); if(newName!==null) b.name=newName;
  const newAccess=prompt('Special Access (yes/no)', b.specialAccess); if(newAccess!==null) b.specialAccess=newAccess;
  const newEffect=prompt('Effect', b.effect); if(newEffect!==null) b.effect=newEffect;
  renderBadges();
}

function deleteBadge(i){
  if(!confirm('Delete this badge?')) return;
  state.badges.splice(i,1);
  renderBadges();
}

</script>
</body>
</html>
<!-- ===== ATTENDANCE SECTION ===== -->
<div class="card">
  <h2>Attendance</h2>
  <div id="currentDateTime" style="margin-bottom:10px; font-weight:bold;"></div>

  <form id="attendanceForm">
    <div id="attendanceList"></div>
    <button type="submit" class="btn btn-primary">Submit Attendance</button>
    <button type="button" class="btn btn-ghost" onclick="exportAttendance()">Export Attendance</button>
    <button type="button" class="btn btn-secondary" onclick="importAttendance()">Import Attendance</button>
  </form>
</div>

<script>
// ===== JavaScript for Attendance =====

state.attendance = state.attendance || []; // initialize if not present

function updateDateTime(){
  const now = new Date();
  document.getElementById('currentDateTime').innerText = 
    now.toLocaleString('en-GB', {weekday:'short', day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'});
}
setInterval(updateDateTime, 1000); // update every second
updateDateTime();

function renderAttendance(){
  const c=document.getElementById('attendanceList');
  c.innerHTML='';
  const students = state.users.filter(u=>u.role==='student');
  if(students.length===0){ c.innerHTML='<div>No students enrolled</div>'; return; }

  students.forEach((s,i)=>{
    const div=document.createElement('div');
    div.style.marginBottom='6px';
    div.innerHTML = `
      <strong>${s.username}</strong>
      <label><input type="radio" name="att_${i}" value="Present"> Present</label>
      <label><input type="radio" name="att_${i}" value="Absent"> Absent</label>
      <label><input type="radio" name="att_${i}" value="Late"> Late</label>
      <label><input type="radio" name="att_${i}" value="On Duty"> On Duty</label>
    `;
    c.appendChild(div);
  });
}

document.getElementById('attendanceForm').addEventListener('submit', e=>{
  e.preventDefault();
  const students = state.users.filter(u=>u.role==='student');
  const now = new Date();
  students.forEach((s,i)=>{
    const selected = document.querySelector(`input[name="att_${i}"]:checked`);
    const status = selected ? selected.value : 'Absent'; // default to absent if none selected
    state.attendance.push({
      student: s.username,
      status: status,
      datetime: now.toISOString()
    });
  });
  alert('Attendance recorded!');
  renderAttendance(); // reset form
});

function exportAttendance(){
  const blob = new Blob([JSON.stringify(state.attendance, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='attendance.json'; a.click();
  URL.revokeObjectURL(url);
}

function importAttendance(){
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = evt=>{
      try {
        const data = JSON.parse(evt.target.result);
        if(Array.isArray(data)){
          state.attendance = data;
          alert('Attendance imported!');
        } else {
          alert('Invalid format');
        }
      } catch(err){ alert('Invalid JSON'); }
    };
    reader.readAsText(file);
  };
  input.click();
}

renderAttendance();
    </script>
    <!-- ===== TEST CREATION SECTION ===== -->
<div class="card">
  <h2>Create Test</h2>
  <form id="createTestForm">
    <label>Test Type</label>
    <select id="testTypeSelect">
      <option value="mcq">MCQ</option>
      <option value="short">Short Answer</option>
    </select>

    <label>Subject</label>
    <input type="text" id="testSubjectInput" placeholder="Subject e.g. Math" required>

    <label>Question</label>
    <textarea id="testQuestionInput" placeholder="Enter the question..." required></textarea>

    <div id="mcqOptionsContainer" style="display:none;">
      <label>Options (comma separated)</label>
      <input type="text" id="mcqOptionsInput" placeholder="Option1, Option2, Option3, Option4">
      <label>Correct Option</label>
      <input type="text" id="mcqAnswerInput" placeholder="Correct option text">
    </div>

    <label>Assign to student (optional)</label>
    <select id="testAssignStudent">
      <option value="">All Students</option>
    </select>

    <div style="margin-top:10px; display:flex; gap:8px;">
      <button type="submit" class="btn btn-primary">Create Test</button>
      <button type="button" class="btn btn-ghost" onclick="renderCreatedTests()">Refresh</button>
    </div>
  </form>

  <div class="space"></div>
  <div class="muted small">Test List</div>
  <div id="createdTestList" class="list"></div>
</div>

<script>
// ===== JavaScript for Test Creation =====
const testTypeSelect = document.getElementById('testTypeSelect');
const mcqContainer = document.getElementById('mcqOptionsContainer');
const assignStudentSelect = document.getElementById('testAssignStudent');

testTypeSelect.addEventListener('change', ()=>{
  mcqContainer.style.display = testTypeSelect.value==='mcq' ? 'block' : 'none';
});

function populateAssignStudents(){
  assignStudentSelect.innerHTML='<option value="">All Students</option>';
  (state.users||[]).filter(u=>u.role==='student').forEach(s=>{
    assignStudentSelect.insertAdjacentHTML('beforeend', `<option value="${s.username}">${s.username}</option>`);
  });
}
populateAssignStudents();

document.getElementById('createTestForm').addEventListener('submit', e=>{
  e.preventDefault();
  const type = testTypeSelect.value;
  const subject = document.getElementById('testSubjectInput').value.trim();
  const question = document.getElementById('testQuestionInput').value.trim();
  const student = assignStudentSelect.value || '';

  if(!subject||!question) return alert('Enter subject & question');

  let testItem = {id:'test_'+Date.now(), type, subject, question, student, published:false};

  if(type==='mcq'){
    const options = document.getElementById('mcqOptionsInput').value.split(',').map(o=>o.trim()).filter(Boolean);
    const answer = document.getElementById('mcqAnswerInput').value.trim();
    if(options.length < 2 || !answer || !options.includes(answer)) return alert('Invalid MCQ options or answer');
    testItem.options = options; testItem.answer = answer;
  }

  state.createdTests = state.createdTests||[];
  state.createdTests.unshift(testItem);
  addLog(`Created ${type} test for ${subject}`);
  saveStorage(); renderCreatedTests();
  document.getElementById('createTestForm').reset();
});

function renderCreatedTests(){
  const c=document.getElementById('createdTestList'); c.innerHTML='';
  (state.createdTests||[]).forEach(t=>{
    const div=document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `
      <strong>[${t.type.toUpperCase()}]</strong> ${t.subject} 
      <div class="small">For: ${t.student||'All'}</div>
      <div>${t.question}</div>
      ${t.type==='mcq'?'<div>Options: '+t.options.join(', ')+' | Answer: '+t.answer+'</div>':''}
      <div style="margin-top:6px;">
        <button class="btn tiny btn-primary" onclick="publishTest('${t.id}')">Publish</button>
        <button class="btn tiny btn-ghost" onclick="editCreatedTest('${t.id}')">Edit</button>
        <button class="btn tiny btn-danger" onclick="deleteCreatedTest('${t.id}')">Delete</button>
        <span class="small" style="margin-left:10px;">${t.published?'Published':'Not Published'}</span>
      </div>
    `;
    c.appendChild(div);
  });
  populateAssignStudents();
}

function publishTest(id){
  const t = state.createdTests.find(x=>x.id===id); if(!t) return;
  t.published = true;
  addLog(`Published test ${t.subject}`);
  saveStorage(); renderCreatedTests();
}

function editCreatedTest(id){
  const t = state.createdTests.find(x=>x.id===id); if(!t) return;
  const newQ = prompt('Question', t.question); if(newQ!==null) t.question=newQ;
  if(t.type==='mcq'){
    const newOpts = prompt('Options (comma separated)', t.options.join(',')); if(newOpts!==null) t.options=newOpts.split(',').map(o=>o.trim());
    const newAns = prompt('Answer', t.answer); if(newAns!==null) t.answer=newAns;
  }
  addLog(`Edited test ${t.subject}`);
  saveStorage(); renderCreatedTests();
}

function deleteCreatedTest(id){
  if(!confirm('Delete this test?')) return;
  state.createdTests = state.createdTests.filter(x=>x.id!==id);
  addLog(`Deleted test ${id}`);
  saveStorage(); renderCreatedTests();
}

// Initial render
renderCreatedTests();
      </script>
      <!-- ===== STUDENT TEST DASHBOARD ===== -->
<div class="card">
  <h2>Available Tests</h2>
  <div id="studentTestList" class="list"></div>
</div>

<script>
// ===== JavaScript for Student Test Interface =====
function renderStudentTests(studentUsername){
  const c = document.getElementById('studentTestList');
  c.innerHTML = '';

  // Only show published tests assigned to all or to this student
  const availableTests = (state.createdTests||[]).filter(t => t.published && (!t.student || t.student === studentUsername));

  if(availableTests.length === 0){
    c.innerHTML = '<div class="small muted">No tests available</div>';
    return;
  }

  availableTests.forEach(t=>{
    const div = document.createElement('div');
    div.style.padding = '8px'; 
    div.style.borderBottom = '1px solid rgba(255,255,255,0.02)';

    let testHtml = `<strong>[${t.type.toUpperCase()}]</strong> ${t.subject}<div>${t.question}</div>`;

    if(t.type === 'mcq'){
      testHtml += '<div>Options:</div>';
      t.options.forEach(opt=>{
        testHtml += `<label style="display:block;"><input type="radio" name="${t.id}" value="${opt}"> ${opt}</label>`;
      });
      testHtml += `<button class="btn tiny btn-primary" onclick="submitMCQ('${t.id}','${studentUsername}')">Submit</button>`;
    } else {
      testHtml += `<textarea id="short_${t.id}" placeholder="Your answer..."></textarea>
                   <button class="btn tiny btn-primary" onclick="submitShort('${t.id}','${studentUsername}')">Submit</button>`;
    }

    div.innerHTML = testHtml;
    c.appendChild(div);
  });
}

// ===== Submit MCQ Test =====
function submitMCQ(testId, studentUsername){
  const t = state.createdTests.find(x=>x.id===testId);
  if(!t) return;
  const selected = document.querySelector(`input[name="${testId}"]:checked`);
  if(!selected) return alert('Select an option');

  const marks = selected.value === t.answer ? 100 : 0;

  // Save marks
  state.tests = state.tests||[];
  const existing = state.tests.find(x=>x.testId===testId && x.student===studentUsername);
  if(existing){
    existing.marks = marks;
  } else {
    state.tests.push({testId, student: studentUsername, marks, subject: t.subject});
  }
  addLog(`Student ${studentUsername} submitted MCQ test ${t.subject} with marks ${marks}`);
  saveStorage(); renderCharts();
  alert(`Submitted! Marks: ${marks}`);
}

// ===== Submit Short Answer Test (Simplified Scoring) =====
function submitShort(testId, studentUsername){
  const t = state.createdTests.find(x=>x.id===testId);
  if(!t) return;
  const ans = document.getElementById(`short_${testId}`).value.trim();
  const marks = ans ? 50 : 0; // optional: teacher can grade later

  state.tests = state.tests||[];
  const existing = state.tests.find(x=>x.testId===testId && x.student===studentUsername);
  if(existing){
    existing.marks = marks;
  } else {
    state.tests.push({testId, student: studentUsername, marks, subject: t.subject});
  }
  addLog(`Student ${studentUsername} submitted short test ${t.subject} with marks ${marks}`);
  saveStorage(); renderCharts();
  alert(`Submitted! Marks: ${marks}`);
}

// Example call: renderStudentTests('student1');
</script>
