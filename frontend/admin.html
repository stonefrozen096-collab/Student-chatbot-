<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Assistant Admin</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg: #1f2937;
    --card: #374151;
    --accent: #4f46e5;
    --text: #f9fafb;
    --muted: #9ca3af;
  }
  body { background: var(--bg); color: var(--text); font-family: sans-serif; margin:0; padding:0;}
  .row { display:flex; flex-wrap:wrap; gap:12px; }
  .col { flex:1; min-width:280px; }
  .card { background: var(--card); padding:16px; border-radius:8px; }
  .btn { padding:6px 12px; cursor:pointer; border:none; border-radius:4px; }
  .btn-primary { background: var(--accent); color:#fff; }
  .btn-ghost { background:transparent; color:#fff; border:1px solid #fff; }
  .btn-danger { background:red; color:#fff; }
  .tiny { padding:3px 6px; font-size:12px; }
  input, select, textarea { width:100%; padding:6px; margin-top:4px; margin-bottom:8px; border-radius:4px; border:none; }
  .list { max-height:300px; overflow-y:auto; }
  .muted { color: var(--muted); }
  .space { height:12px; }
</style>
</head>
<body>
<div class="row">
  <div class="col card">
    <h2>Admin Profile</h2>
    <div><strong>Name:</strong> <span id="adminNameDisplay"></span></div>
    <div><strong>Email:</strong> <span id="adminEmailDisplay"></span></div>
    <button class="btn btn-primary" onclick="openEditProfile()">Edit Profile</button>
  </div>
  <div class="col card">
    <h2>Theme</h2>
    <button class="btn btn-primary" onclick="toggleTheme()">Toggle Dark/Light</button>
  </div>
</div>
<div class="space"></div>
<div class="row">
  <div class="col card">
    <h3>Analytics Summary</h3>
    <div><strong>Average Attendance:</strong> <span id="avgAttendance">0%</span></div>
    <div><strong>Average Marks:</strong> <span id="avgMarks">0</span></div>
    <div><strong>Top Student:</strong> <span id="topStudent">N/A</span></div>
  </div>
  <div class="col card">
    <h3>Search Users</h3>
    <input type="text" id="searchUsers" placeholder="Search by username or role" />
  </div>
  <div class="col card">
    <h3>Search Attendance</h3>
    <input type="text" id="searchAttendance" placeholder="Search by subject" />
  </div>
  <div class="col card">
    <h3>Search Tests</h3>
    <input type="text" id="searchTests" placeholder="Search by subject" />
  </div>
</div>
<div class="space"></div>
<!-- PART 3: Attendance, Tests, Charts -->
<div class="col card">
  <h3>Attendance (subjects & %)</h3>
  <form id="attendanceForm">
    <label>Subject name</label>
    <input id="attendanceSubject" type="text" placeholder="e.g. Mathematics" required>

    <label>Percentage</label>
    <input id="attendancePercent" type="number" min="0" max="100" placeholder="80" required>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn btn-primary" type="submit">Add / Update</button>
      <button class="btn btn-ghost" type="button" onclick="renderAttendance()">Refresh</button>
    </div>
  </form>

  <div class="space"></div>
  <div class="muted small">Attendance list</div>
  <div id="attendanceList" class="list"></div>

  <div class="space"></div>
  <label>Delete subject</label>
  <div class="inline">
    <select id="deleteSubjectSelect"></select>
    <button class="btn btn-danger tiny" onclick="deleteSubject()">Delete</button>
  </div>
</div>

<div class="col card">
  <h3>Test Scores</h3>
  <form id="testForm">
    <label>Subject</label>
    <input id="testSubject" type="text" placeholder="e.g. Physics" required>
    <label>Marks</label>
    <input id="testMarks" type="number" min="0" max="100" placeholder="75" required>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn btn-primary" type="submit">Add / Update test</button>
      <button class="btn btn-ghost" type="button" onclick="renderTests()">Refresh</button>
    </div>
  </form>

  <div class="space"></div>
  <div class="muted small">Test list</div>
  <div id="testList" class="list"></div>

  <div class="space"></div>
  <label>Delete test</label>
  <div class="inline">
    <select id="deleteTestSelect"></select>
    <button class="btn btn-danger tiny" onclick="deleteTest()">Delete</button>
  </div>
</div>

<!-- Charts -->
<div class="col card">
  <h3>Attendance Chart</h3>
  <canvas id="attendanceChart"></canvas>
  <div class="space"></div>
  <div class="muted small">Edit a subject's % directly: choose subject -> change value -> click Update</div>
  <div class="inline" style="margin-top:8px">
    <select id="chartEditSubject"></select>
    <input id="chartEditValue" type="number" min="0" max="100" placeholder="%" />
    <button class="btn btn-primary" onclick="applyChartEdit()">Update</button>
  </div>
</div>

<div class="col card">
  <h3>Test Chart</h3>
  <canvas id="testChart"></canvas>
  <div class="space"></div>
  <div class="muted small">Edit test marks: choose test -> change marks -> Update</div>
  <div class="inline" style="margin-top:8px">
    <select id="chartEditTest"></select>
    <input id="chartEditTestValue" type="number" min="0" max="100" placeholder="marks" />
    <button class="btn btn-primary" onclick="applyTestEdit()">Update</button>
  </div>
</div>

<script>
/* ---------- Attendance ---------- */
document.getElementById('attendanceForm').addEventListener('submit', e=>{
  e.preventDefault();
  const subj = document.getElementById('attendanceSubject').value.trim();
  const percent = parseFloat(document.getElementById('attendancePercent').value);
  if(!subj || isNaN(percent)) return alert('enter valid subject & percent');
  const found = state.attendance.find(a=>a.subject.toLowerCase()===subj.toLowerCase());
  if(found){ found.percent = percent; addLog(`Updated attendance ${subj} -> ${percent}%`); }
  else { state.attendance.unshift({ subject: subj, percent }); addLog(`Added attendance ${subj} -> ${percent}%`); }
  persistAndRender();
  document.getElementById('attendanceForm').reset();
});

function renderAttendance(){
  const c = document.getElementById('attendanceList');
  c.innerHTML = '';
  (state.attendance||[]).forEach(a=>{
    const div = document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>${a.subject}</strong> — ${a.percent}% 
      <div style="margin-top:6px">
        <button class="btn tiny btn-ghost" onclick="promptEditAttendance('${a.subject}')">Edit</button>
        <button class="btn tiny btn-danger" onclick="deleteSubjectByName('${a.subject}')">Delete</button>
      </div>`;
    c.appendChild(div);
  });
  const sel = document.getElementById('deleteSubjectSelect');
  sel.innerHTML = (state.attendance||[]).map(a=>`<option value="${a.subject}">${a.subject}</option>`).join('') || '<option value="">No subjects</option>';
  document.getElementById('chartEditSubject').innerHTML = (state.attendance||[]).map(a=>`<option value="${a.subject}">${a.subject}</option>`).join('');
}

function deleteSubject(){
  const sel = document.getElementById('deleteSubjectSelect').value;
  if(!sel) return alert('choose subject');
  deleteSubjectByName(sel);
}
function deleteSubjectByName(name){
  if(!confirm(`Delete subject ${name}?`)) return;
  state.attendance = state.attendance.filter(a=>a.subject!==name);
  addLog(`Deleted subject ${name} from attendance`);
  persistAndRender();
}
function promptEditAttendance(subject){
  const item = state.attendance.find(a=>a.subject===subject);
  if(!item) return;
  const v = prompt(`Enter new % for ${subject}`, item.percent);
  if(v===null) return;
  const nv = parseFloat(v);
  if(isNaN(nv)) return alert('invalid number');
  item.percent = nv;
  addLog(`Edited attendance ${subject} -> ${nv}%`);
  persistAndRender();
}

/* ---------- Tests ---------- */
document.getElementById('testForm').addEventListener('submit', e=>{
  e.preventDefault();
  const subj = document.getElementById('testSubject').value.trim();
  const marks = parseFloat(document.getElementById('testMarks').value);
  if(!subj || isNaN(marks)) return alert('enter valid test & marks');
  const found = state.tests.find(t=>t.subject.toLowerCase()===subj.toLowerCase());
  if(found){ found.marks = marks; addLog(`Updated test ${subj} -> ${marks}`); }
  else { state.tests.unshift({ subject: subj, marks }); addLog(`Added test ${subj} -> ${marks}`); }
  persistAndRender();
  document.getElementById('testForm').reset();
});

function renderTests(){
  const c = document.getElementById('testList');
  c.innerHTML = '';
  (state.tests||[]).forEach(t=>{
    const div = document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>${t.subject}</strong> — ${t.marks} 
      <div style="margin-top:6px">
        <button class="btn tiny btn-ghost" onclick="promptEditTest('${t.subject}')">Edit</button>
        <button class="btn tiny btn-danger" onclick="deleteTestByName('${t.subject}')">Delete</button>
      </div>`;
    c.appendChild(div);
  });
  document.getElementById('deleteTestSelect').innerHTML = (state.tests||[]).map(t=>`<option value="${t.subject}">${t.subject}</option>`).join('') || '<option value="">No tests</option>';
  document.getElementById('chartEditTest').innerHTML = (state.tests||[]).map(t=>`<option value="${t.subject}">${t.subject}</option>`).join('');
}

function deleteTest(){
  const sel = document.getElementById('deleteTestSelect').value;
  if(!sel) return alert('choose test');
  deleteTestByName(sel);
}
function deleteTestByName(name){
  if(!confirm(`Delete test ${name}?`)) return;
  state.tests = state.tests.filter(t=>t.subject!==name);
  addLog(`Deleted test ${name}`);
  persistAndRender();
}
function promptEditTest(subject){
  const item = state.tests.find(t=>t.subject===subject);
  if(!item) return;
  const v = prompt(`Enter new marks for ${subject}`, item.marks);
  if(v===null) return;
  const nv = parseFloat(v);
  if(isNaN(nv)) return alert('invalid number');
  item.marks = nv;
  addLog(`Edited test ${subject} -> ${nv}`);
  persistAndRender();
}

/* ---------- Charts ---------- */
let attendanceChart=null, testChart=null;
function renderCharts(){
  const attCtx = document.getElementById('attendanceChart').getContext('2d');
  const testCtx = document.getElementById('testChart').getContext('2d');

  const attLabels = (state.attendance||[]).map(a=>a.subject);
  const attData = (state.attendance||[]).map(a=>a.percent);

  const testLabels = (state.tests||[]).map(t=>t.subject);
  const testData = (state.tests||[]).map(t=>t.marks);

  if(attendanceChart) {
    attendanceChart.data.labels = attLabels;
    attendanceChart.data.datasets[0].data = attData;
    attendanceChart.update();
  } else {
    attendanceChart = new Chart(attCtx, {
      type:'bar',
      data:{ labels:attLabels, datasets:[{label:'Attendance %',data:attData, backgroundColor:'#4f46e5'}]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  }

  if(testChart) {
    testChart.data.labels = testLabels;
    testChart.data.datasets[0].data = testData;
    testChart.update();
  } else {
    testChart = new Chart(testCtx, {
      type:'bar',
      data:{ labels:testLabels, datasets:[{label:'Test marks',data:testData, backgroundColor:'#3b82f6'}]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  }

  // populate chart edit selects
  document.getElementById('chartEditSubject').innerHTML = (state.attendance||[]).map(a=>`<option value="${a.subject}">${a.subject}</option>`).join('');
  document.getElementById('chartEditTest').innerHTML = (state.tests||[]).map(t=>`<option value="${t.subject}">${t.subject}</option>`).join('');
}

function applyChartEdit(){
  const subj = document.getElementById('chartEditSubject').value;
  const val = parseFloat(document.getElementById('chartEditValue').value);
  if(!subj || isNaN(val)) return alert('choose subject and value');
  const item = state.attendance.find(a=>a.subject===subj);
  if(item){ item.percent = val; addLog(`Chart edit: ${subj} -> ${val}%`); persistAndRender(); }
}

function applyTestEdit(){
  const subj = document.getElementById('chartEditTest').value;
  const val = parseFloat(document.getElementById('chartEditTestValue').value);
  if(!subj || isNaN(val)) return alert('choose test and marks');
  const item = state.tests.find(t=>t.subject===subj);
  if(item){ item.marks = val; addLog(`Test edit: ${subj} -> ${val}`); persistAndRender(); }
}
  <div class="row">
  <div class="col card">
    <h3>Trigger Words & Phrases</h3>
    <form id="triggerForm">
      <label>Add Trigger Word/Phrase</label>
      <input id="triggerInput" type="text" placeholder="e.g. urgent, help needed" />
      <button class="btn btn-primary" type="submit">Add Trigger</button>
    </form>

    <div class="space"></div>
    <div class="muted small">Existing Triggers</div>
    <div id="triggerList" class="list"></div>
  </div>
</div>
  <script>
const STORAGE_KEY = 'student_assistant_data_v2';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  admin: { name:'Admin', email:'admin@example.com' },
  users: [], batches:Array.from({length:20},(_,i)=>i+1),
  academic:[], attendance:[], tests:[], feedback:[], logs:[], triggers:[]
};

// ---------- Utilities ----------
function saveState(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); renderAll(); }
function addLog(msg){ state.logs.unshift(`${new Date().toISOString()} — ${msg}`); saveState(); }

// ---------- Theme ----------
let darkTheme = true;
function toggleTheme(){
  if(darkTheme){
    document.documentElement.style.setProperty('--bg','#fff');
    document.documentElement.style.setProperty('--card','#f3f4f6');
    document.documentElement.style.setProperty('--accent','#4f46e5');
    document.documentElement.style.setProperty('--text','#111');
    document.documentElement.style.setProperty('--muted','#6b7280');
  } else {
    document.documentElement.style.setProperty('--bg','#1f2937');
    document.documentElement.style.setProperty('--card','#374151');
    document.documentElement.style.setProperty('--accent','#4f46e5');
    document.documentElement.style.setProperty('--text','#f9fafb');
    document.documentElement.style.setProperty('--muted','#9ca3af');
  }
  darkTheme = !darkTheme;
}

// ---------- Admin Profile ----------
function renderAdminProfile(){
  document.getElementById('adminNameDisplay').textContent = state.admin.name;
  document.getElementById('adminEmailDisplay').textContent = state.admin.email;
}
function openEditProfile(){
  const newName = prompt('Admin name', state.admin.name);
  if(newName) state.admin.name = newName;
  const newEmail = prompt('Admin email', state.admin.email);
  if(newEmail) state.admin.email = newEmail;
  addLog('Admin profile updated');
  saveState();
}

// ---------- Trigger Words ----------
function renderTriggers(){
  const c=document.getElementById('triggerList');
  if(!state.triggers.length){ c.innerHTML='<div class="small muted">No triggers set</div>'; return; }
  c.innerHTML='';
  state.triggers.forEach((t,i)=>{
    const div=document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.1)';
    div.innerHTML=`<span>${t}</span>
      <button class="btn tiny btn-ghost" onclick="editTrigger(${i})">Edit</button>
      <button class="btn tiny btn-danger" onclick="deleteTrigger(${i})">Delete</button>`;
    c.appendChild(div);
  });
}
document.getElementById('triggerForm').addEventListener('submit', e=>{
  e.preventDefault();
  const val=document.getElementById('triggerInput').value.trim();
  if(!val || state.triggers.includes(val)) return alert('Invalid or duplicate trigger');
  state.triggers.push(val);
  addLog(`Added trigger: ${val}`);
  document.getElementById('triggerInput').value='';
  saveState();
});
function editTrigger(i){
  const newVal = prompt('Edit trigger', state.triggers[i]);
  if(newVal) { addLog(`Trigger edited: ${state.triggers[i]} -> ${newVal}`); state.triggers[i]=newVal; saveState(); }
}
function deleteTrigger(i){ addLog(`Trigger deleted: ${state.triggers[i]}`); state.triggers.splice(i,1); saveState(); }

// ---------- Check triggers ----------
function checkTriggers(text){
  state.triggers.forEach(t=>{
    if(text.toLowerCase().includes(t.toLowerCase())) addLog(`⚠️ Trigger detected: "${t}" in "${text}"`);
  });
}

// ---------- Render All ----------
function renderAll(){
  renderAdminProfile();
  renderTriggers();
  // renderUsers(); renderAttendance(); renderTests(); renderCharts(); renderFeedback(); renderLogs();
}

renderAll();
</script>
