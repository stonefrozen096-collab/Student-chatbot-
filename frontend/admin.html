<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard — Student Assistant</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f1724; --accent:#4f46e5; --accent-2:#3b82f6; --muted:#9aa7b2; --glass: rgba(255,255,255,0.03);
    }
    [data-theme="light"] {
      --bg:#f4f4f4; --card:#ffffff; --accent:#4f46e5; --accent-2:#3b82f6; --muted:#6b7280; --glass: rgba(0,0,0,0.05);
      color: #111;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,Arial; background:var(--bg); color:inherit}
    .wrap{max-width:1180px;margin:28px auto;padding:18px;position:relative;z-index:2}
    h1,h3{margin:0 0 12px;font-weight:600;color:var(--accent)}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(3,7,18,0.6);border:1px solid rgba(255,255,255,0.02)}
    .muted{color:var(--muted);font-size:13px}
    input, textarea, select{width:100%;padding:9px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;margin-top:6px}
    textarea{resize:vertical;min-height:72px}
    .btn{display:inline-block;padding:9px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit}
    .btn-danger{background:#ef4444;color:white}
    .top-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .avatar{width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:22px}
    .small{font-size:13px;color:var(--muted)}
    .list{margin-top:12px;max-height:240px;overflow:auto;padding-right:6px}
    table{width:100%;border-collapse:collapse;color:inherit}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:13px}
    th{background:rgba(255,255,255,0.02);font-weight:600}
    .inline{display:flex;gap:8px;align-items:center}
    .inline > * {flex:1}
    #bg-canvas{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.5}
    ::-webkit-scrollbar {height:8px;width:8px}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:6px}
  </style>
</head>
<body data-theme="dark">
<canvas id="bg-canvas" aria-hidden="true"></canvas>

<div class="wrap">
  <div class="row" style="align-items:center;justify-content:space-between">
    <div>
      <h1>Admin Dashboard — Student Assistant</h1>
      <div class="muted">Manage users, badges, batches, academic items, attendance, tests, analytics, logs, and triggers</div>
    </div>
    <div class="top-actions">
      <!-- Theme toggle -->
      <button class="btn btn-ghost" id="themeToggle">Toggle Theme</button>
      <!-- Admin profile card -->
      <div class="profile-row card" style="padding:10px 14px">
        <div class="avatar" id="adminAvatar">A</div>
        <div>
          <div id="adminNameDisplay" style="font-weight:700">Admin</div>
          <div class="small" id="adminEmailDisplay">admin@example.com</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Users Management -->
    <div class="col card">
      <h3>User Management</h3>
      <input type="text" id="userSearch" placeholder="Search users...">
      <form id="createUserForm">
        <label>Role</label>
        <select id="newUserRole">
          <option value="admin">Admin</option>
          <option value="moderator">Moderator</option>
          <option value="tester">Tester</option>
          <option value="faculty">Faculty</option>
          <option value="student">Student</option>
        </select>
        <label>Username / Email / RegNo</label>
        <input type="text" id="newUserName" placeholder="example@domain.com or REG123" required>
        <label>Password (optional)</label>
        <input type="password" id="newUserPassword" placeholder="password (optional)">
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-primary" type="submit">Create user</button>
          <button class="btn btn-ghost" type="button" onclick="exportData()">Export JSON</button>
          <button class="btn btn-ghost" type="button" onclick="importDataPrompt()">Import JSON</button>
        </div>
      </form>
      <div class="muted small">Existing users</div>
      <div class="list">
        <table id="usersTable">
          <thead><tr><th>User</th><th>Role</th><th>Badges</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <label>Delete user</label>
      <div class="inline">
        <select id="deleteUserSelect"></select>
        <button class="btn btn-danger tiny" onclick="deleteUser()">Delete</button>
      </div>
    </div>

    <!-- Badge & Batch Management -->
    <div class="col card">
      <h3>Badge Management</h3>
      <label>Choose user</label>
      <select id="badgeUserSelect"></select>
      <label>Badge to assign</label>
      <select id="badgeRoleSelect">
        <option value="admin">Admin</option>
        <option value="moderator">Moderator</option>
        <option value="tester">Tester</option>
        <option value="faculty">Faculty</option>
        <option value="student">Student</option>
      </select>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-primary" onclick="assignBadge()">Assign</button>
        <button class="btn btn-ghost" onclick="removeBadge()">Remove</button>
      </div>

      <div class="space"></div>
      <h3>Batch Management</h3>
      <label>Select batch to remove</label>
      <select id="batchSelect"></select>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-danger" onclick="deleteBatch()">Delete batch</button>
      </div>
    </div>

    <!-- Admin Profile & Logs -->
    <div class="col card">
      <h3>Admin Profile</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <div><strong id="adminNameSmall">Admin</strong><div class="small" id="adminEmailSmall">admin@example.com</div></div>
      </div>
      <div class="space"></div>
      <button class="btn btn-primary" onclick="openEditProfile()">Edit profile</button>
      <button class="btn btn-ghost" onclick="clearAllData()">Clear all data</button>

      <div class="space"></div>
      <h3>Logs</h3>
      <div class="logs" id="logsContainer"></div>
    </div>
  </div>
</div>
<div class="wrap">

  <!-- ROW 2: Academic | Attendance | Tests -->
  <div class="row">
    <!-- Academic items -->
    <div class="col card">
      <h3>Academic items (Notes / Assignments / Notices)</h3>
      <input type="text" id="acadSearch" placeholder="Search academic items...">
      <form id="acadForm">
        <label>Type</label>
        <select id="acadType">
          <option value="note">Note</option>
          <option value="assignment">Assignment</option>
          <option value="notice">Notice</option>
        </select>
        <label>Title/Subject</label>
        <input id="acadTitle" type="text" placeholder="Title or subject">
        <label>Content</label>
        <textarea id="acadContent" placeholder="Content..."></textarea>

        <label>Assign to student (optional)</label>
        <select id="acadStudentSelect"><option value="">All students</option></select>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-primary" type="submit">Add item</button>
          <button class="btn btn-ghost" type="button" onclick="renderAcademic()">Refresh</button>
        </div>
      </form>

      <div class="space"></div>
      <div class="muted small">Academic list</div>
      <div id="academicList" class="list"></div>
    </div>

    <!-- Attendance -->
    <div class="col card">
      <h3>Attendance (subjects & %)</h3>
      <input type="text" id="attendanceSearch" placeholder="Search attendance...">
      <form id="attendanceForm">
        <label>Subject name</label>
        <input id="attendanceSubject" type="text" placeholder="e.g. Mathematics" required>

        <label>Percentage</label>
        <input id="attendancePercent" type="number" min="0" max="100" placeholder="80" required>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-primary" type="submit">Add / Update</button>
          <button class="btn btn-ghost" type="button" onclick="renderAttendance()">Refresh</button>
        </div>
      </form>

      <div class="space"></div>
      <div class="muted small">Attendance list</div>
      <div id="attendanceList" class="list"></div>

      <div class="space"></div>
      <label>Delete subject</label>
      <div class="inline">
        <select id="deleteSubjectSelect"></select>
        <button class="btn btn-danger tiny" onclick="deleteSubject()">Delete</button>
      </div>
    </div>

    <!-- Test Scores -->
    <div class="col card">
      <h3>Test Scores</h3>
      <input type="text" id="testSearch" placeholder="Search tests...">
      <form id="testForm">
        <label>Subject</label>
        <input id="testSubject" type="text" placeholder="e.g. Physics" required>
        <label>Marks</label>
        <input id="testMarks" type="number" min="0" max="100" placeholder="75" required>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-primary" type="submit">Add / Update test</button>
          <button class="btn btn-ghost" type="button" onclick="renderTests()">Refresh</button>
        </div>
      </form>

      <div class="space"></div>
      <div class="muted small">Test list</div>
      <div id="testList" class="list"></div>

      <div class="space"></div>
      <label>Delete test</label>
      <div class="inline">
        <select id="deleteTestSelect"></select>
        <button class="btn btn-danger tiny" onclick="deleteTest()">Delete</button>
      </div>
    </div>
  </div>

  <div class="space"></div>

  <!-- Analytics summary cards -->
  <div class="row">
    <div class="col card">
      <h3>Analytics Summary</h3>
      <div class="inline" style="margin-bottom:10px">
        <div class="card" style="flex:1;padding:12px;text-align:center">
          <strong>Average Attendance</strong>
          <div id="avgAttendance">0%</div>
        </div>
        <div class="card" style="flex:1;padding:12px;text-align:center">
          <strong>Average Test Marks</strong>
          <div id="avgTestMarks">0</div>
        </div>
        <div class="card" style="flex:1;padding:12px;text-align:center">
          <strong>Top Student</strong>
          <div id="topStudent">-</div>
        </div>
      </div>
      <div class="muted small">Updates in real time when data changes</div>
    </div>
  </div>
</div>
<!-- ROW 3: Charts, Feedback, Trigger words -->
<div class="row">
  <!-- Attendance Chart -->
  <div class="col card">
    <h3>Attendance Chart</h3>
    <canvas id="attendanceChart"></canvas>
    <div class="space"></div>
    <div class="muted small">Edit a subject's % directly: choose subject -> change value -> click Update</div>
    <div class="inline" style="margin-top:8px">
      <select id="chartEditSubject"></select>
      <input id="chartEditValue" type="number" min="0" max="100" placeholder="%"/>
      <button class="btn btn-primary" onclick="applyChartEdit()">Update</button>
    </div>
  </div>

  <!-- Test Chart -->
  <div class="col card">
    <h3>Test Chart</h3>
    <canvas id="testChart"></canvas>
    <div class="space"></div>
    <div class="muted small">Edit test marks: choose test -> change marks -> Update</div>
    <div class="inline" style="margin-top:8px">
      <select id="chartEditTest"></select>
      <input id="chartEditTestValue" type="number" min="0" max="100" placeholder="marks"/>
      <button class="btn btn-primary" onclick="applyTestEdit()">Update</button>
    </div>
  </div>

  <!-- Feedback, Logs, Trigger Words -->
  <div class="col card">
    <h3>Feedback</h3>
    <div id="feedbackList" class="list muted-block">No feedback yet</div>
    <div class="space"></div>
    <h3>Trigger Words / Phrases</h3>
    <input type="text" id="triggerInput" placeholder="Add trigger word or phrase">
    <button class="btn btn-primary tiny" onclick="addTrigger()">Add Trigger</button>
    <div id="triggerList" class="list small"></div>
    <div class="space"></div>
    <h3>Action Logs / Alerts</h3>
    <div id="actionLogs" class="logs"></div>
  </div>
</div>

<script>
/* ---------- Charts ---------- */
let attendanceChart = null, testChart = null;
function renderCharts(){
  const attCtx = document.getElementById('attendanceChart').getContext('2d');
  const testCtx = document.getElementById('testChart').getContext('2d');

  const attLabels = (state.attendance||[]).map(a=>a.subject);
  const attData = (state.attendance||[]).map(a=>a.percent);

  const testLabels = (state.tests||[]).map(t=>t.subject);
  const testData = (state.tests||[]).map(t=>t.marks);

  if(attendanceChart){
    attendanceChart.data.labels = attLabels;
    attendanceChart.data.datasets[0].data = attData;
    attendanceChart.update();
  } else {
    attendanceChart = new Chart(attCtx, {
      type:'bar',
      data:{ labels:attLabels, datasets:[{label:'Attendance %',data:attData, backgroundColor:'#4f46e5'}]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  }

  if(testChart){
    testChart.data.labels = testLabels;
    testChart.data.datasets[0].data = testData;
    testChart.update();
  } else {
    testChart = new Chart(testCtx, {
      type:'bar',
      data:{ labels:testLabels, datasets:[{label:'Test marks',data:testData, backgroundColor:'#3b82f6'}]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  }

  document.getElementById('chartEditSubject').innerHTML = (state.attendance||[]).map(a=>`<option value="${a.subject}">${a.subject}</option>`).join('');
  document.getElementById('chartEditTest').innerHTML = (state.tests||[]).map(t=>`<option value="${t.subject}">${t.subject}</option>`).join('');
}

/* ---------- Trigger Words / Phrases ---------- */
if(!state.triggers) state.triggers = []; // initialize
function renderTriggers(){
  const c = document.getElementById('triggerList');
  c.innerHTML = state.triggers.map(t=>`<div style="padding:4px;border-bottom:1px solid #ccc">
    ${t} <button class="btn btn-danger tiny" onclick="removeTrigger('${t.replace(/'/g,"\\'")}')">Delete</button>
  </div>`).join('') || '<div class="small muted">No triggers</div>';
}
function addTrigger(){
  const val = document.getElementById('triggerInput').value.trim();
  if(!val) return alert('Enter trigger');
  if(!state.triggers.includes(val)){
    state.triggers.push(val);
    addLog(`Added trigger word/phrase: ${val}`);
    persistAndRender();
    document.getElementById('triggerInput').value='';
  } else alert('Trigger already exists');
}
function removeTrigger(t){
  state.triggers = state.triggers.filter(x=>x!==t);
  addLog(`Removed trigger: ${t}`);
  persistAndRender();
}

/* ---------- Real-time trigger check ---------- */
function checkTrigger(text){
  (state.triggers||[]).forEach(trigger=>{
    if(text.toLowerCase().includes(trigger.toLowerCase())){
      addLog(`⚡ Trigger detected: "${trigger}" in "${text}"`);
      renderLogs();
    }
  });
}

/* ---------- Override Academic/Feedback add for triggers ---------- */
const originalAddAcademic = document.getElementById('acadForm').onsubmit;
document.getElementById('acadForm').addEventListener('submit', e=>{
  const content = document.getElementById('acadContent').value.trim();
  checkTrigger(content);
});

const originalAddFeedback = (msg)=>{
  checkTrigger(msg);
};
                       </script>
                       <!-- ROW 4: Analytics & Theme / Student Login -->
<div class="row">
  <!-- Analytics summary cards -->
  <div class="col card">
    <h3>Analytics Summary</h3>
    <div class="space"></div>
    <div id="analyticsSummary" class="list small"></div>
  </div>

  <!-- Dark / Light Theme Toggle -->
  <div class="col card">
    <h3>Theme</h3>
    <button class="btn btn-primary" onclick="toggleTheme()">Toggle Dark/Light Theme</button>
  </div>

  <!-- Student Login -->
  <div class="col card">
    <h3>Student Dashboard</h3>
    <input type="text" id="studentLoginInput" placeholder="Enter student username">
    <button class="btn btn-primary" onclick="loginStudent()">Login as Student</button>
    <button class="btn btn-ghost" onclick="logoutStudent()">Logout</button>
    <div class="space"></div>
    <div id="studentDashboardInfo" class="small muted"></div>
  </div>
</div>

<script>
/* ---------- Dark / Light Theme ---------- */
let darkMode = false;
function toggleTheme(){
  darkMode = !darkMode;
  const root = document.documentElement;
  if(darkMode){
    root.style.setProperty('--bg','#1f1f2e');
    root.style.setProperty('--card','#2a2a3f');
    root.style.setProperty('--text','#f5f5f5');
    root.style.setProperty('--accent','#4f46e5');
  } else {
    root.style.setProperty('--bg','#f0f0f0');
    root.style.setProperty('--card','#ffffff');
    root.style.setProperty('--text','#111');
    root.style.setProperty('--accent','#4f46e5');
  }
  addLog(`Theme changed to ${darkMode ? 'Dark' : 'Light'}`);
}

/* ---------- Analytics Summary ---------- */
function renderAnalytics(){
  const summaryDiv = document.getElementById('analyticsSummary');
  const attendance = state.attendance || [];
  const tests = state.tests || [];
  const users = state.users.filter(u=>u.role==='student') || [];

  const avgAttendance = attendance.length ? (attendance.reduce((a,b)=>a+b.percent,0)/attendance.length).toFixed(2) : 0;
  const avgMarks = tests.length ? (tests.reduce((a,b)=>a+b.marks,0)/tests.length).toFixed(2) : 0;

  // Top student based on average test marks
  const topStudent = users.length ? users.map(u=>{
    const studentTests = tests.filter(t=>t.student===u.username || !t.student);
    const avg = studentTests.length ? studentTests.reduce((a,b)=>a+b.marks,0)/studentTests.length : 0;
    return {username:u.username, avg};
  }).sort((a,b)=>b.avg-a.avg)[0] : {username:'N/A', avg:0};

  summaryDiv.innerHTML = `
    <div>Average Attendance: <strong>${avgAttendance}%</strong></div>
    <div>Average Test Marks: <strong>${avgMarks}</strong></div>
    <div>Top Student: <strong>${topStudent.username} (${topStudent.avg.toFixed(2)})</strong></div>
  `;
}

/* ---------- Student-specific Dashboard ---------- */
let currentStudent = null;
function loginStudent(){
  const username = document.getElementById('studentLoginInput').value.trim();
  const user = state.users.find(u=>u.username===username && u.role==='student');
  if(!user) return alert('Student not found');
  currentStudent = username;
  addLog(`Logged in as student: ${username}`);
  document.getElementById('studentDashboardInfo').innerText = `Logged in as: ${username}`;
  filterForStudent();
}
function logoutStudent(){
  currentStudent = null;
  addLog(`Student logged out`);
  document.getElementById('studentDashboardInfo').innerText = '';
  renderAll();
}
function filterForStudent(){
  if(!currentStudent) return renderAll();
  // Filter academic items for this student
  const acadList = document.getElementById('academicList');
  acadList.innerHTML = '';
  state.academic.filter(a=>!a.student || a.student===currentStudent).forEach(a=>{
    const div = document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>[${a.type.toUpperCase()}]</strong> ${a.title} 
      <div class="small">${a.student ? 'For: '+a.student : 'For: All'}</div>
      <div style="margin-top:6px">${a.content}</div>`;
    acadList.appendChild(div);
  });
  // Filter attendance
  const attList = document.getElementById('attendanceList');
  attList.innerHTML = '';
  state.attendance.forEach(a=>{
    const div = document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>${a.subject}</strong> — ${a.percent}%`;
    attList.appendChild(div);
  });
  // Filter tests
  const testList = document.getElementById('testList');
  testList.innerHTML = '';
  state.tests.forEach(t=>{
    const div = document.createElement('div');
    div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>${t.subject}</strong> — ${t.marks}`;
    testList.appendChild(div);
  });
}

/* ---------- Search / Filter for Users, Attendance, Tests ---------- */
function filterList(listId, searchInputId){
  const query = document.getElementById(searchInputId).value.toLowerCase();
  const container = document.getElementById(listId);
  Array.from(container.children).forEach(div=>{
    const text = div.innerText.toLowerCase();
    div.style.display = text.includes(query) ? '' : 'none';
  });
}
    </script>
